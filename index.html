<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#8b4513">
    <meta name="description" content="Expert field guide for identifying and authenticating valuable Caucasian carpet fragments">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Carpet Expert">
    <link rel="manifest" id="manifest-placeholder">
    <title>Carpet Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'carpet-dark': '#1a1a2e',
                        'carpet-medium': '#2d3250',
                        'carpet-light': '#424769',
                        'carpet-gold': '#ffd700',
                        'carpet-bronze': '#d2691e',
                        'carpet-copper': '#8b4513',
                    }
                }
            }
        }
    </script>
    <style>
        input, select, textarea { font-size: 16px !important; }
        html { scroll-behavior: smooth; }
        body { overflow-x: hidden; width: 100vw; max-width: 100%; }
        * { max-width: 100%; }
        img { max-width: 100%; height: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -100%); } to { opacity: 1; transform: translate(-50%, 0); } }
        .fade-in { animation: fadeIn 0.5s; }
        .slide-in { animation: slideIn 0.5s; }
        .search-highlight { background-color: rgba(255, 215, 0, 0.2) !important; border: 3px solid #ffd700 !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-carpet-dark to-[#16213e] text-gray-200 min-h-screen font-serif">
    
    <!-- Install Prompt -->
    <div id="installPrompt" class="hidden mx-4 mt-4 bg-gradient-to-r from-green-700 to-green-600 text-white p-4 rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <p class="font-bold text-sm md:text-base">üì± Install Carpet Expert</p>
                <p class="text-xs md:text-sm opacity-90">Works offline in bazaars</p>
            </div>
            <button onclick="installPWA()" class="bg-white text-green-700 px-4 py-2 rounded-lg font-bold text-sm ml-3 hover:bg-green-50">
                Install
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-3 md:px-6 py-4 md:py-6">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-carpet-copper to-carpet-bronze p-4 md:p-8 rounded-xl md:rounded-2xl mb-4 md:mb-6 shadow-2xl text-center">
            <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold mb-2 md:mb-3 text-shadow">üß≠ Carpet Fragment Expert</h1>
            <p class="text-sm md:text-lg lg:text-xl opacity-90 italic">Armenia ‚Ä¢ Azerbaijan ‚Ä¢ Georgia ‚Ä¢ Albania ‚Ä¢ Bulgaria</p>
            <div class="mt-3 md:mt-4 text-xs md:text-sm bg-black bg-opacity-20 inline-block px-4 py-2 rounded-lg">
                <span class="inline-block mr-2">‚úì Offline Ready</span>
                <span class="inline-block">‚úì Mobile Optimized</span>
            </div>
        </header>

        <!-- Priority Finds Quick Reference -->
        <div class="bg-gradient-to-r from-red-900 to-red-700 p-4 md:p-6 rounded-xl md:rounded-2xl mb-4 md:mb-6 border-4 border-carpet-gold shadow-xl">
            <div class="flex items-center justify-between mb-3 md:mb-4 cursor-pointer" onclick="togglePriorityBuys()">
                <h2 class="text-lg md:text-2xl font-bold text-carpet-gold">‚ö° PRIORITY BUYS - Quick Recognition</h2>
                <button id="priorityToggle" class="bg-black bg-opacity-30 hover:bg-opacity-50 px-3 md:px-4 py-2 rounded-lg font-bold text-sm md:text-base transition-all">
                    ‚ñº Hide
                </button>
            </div>
            <div id="priorityBuysContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                <div class="bg-black bg-opacity-30 p-3 md:p-4 rounded-lg">
                    <div class="text-carpet-gold font-bold text-base md:text-lg mb-1">üêâ Armenian Dragon</div>
                    <div class="text-xs md:text-sm mb-1">S-curved vishap motif</div>
                    <div class="text-green-400 font-bold text-sm md:text-base">$8K-$80K+</div>
                </div>
                <div class="bg-black bg-opacity-30 p-3 md:p-4 rounded-lg">
                    <div class="text-carpet-gold font-bold text-base md:text-lg mb-1">üïå Shirvan Prayer</div>
                    <div class="text-xs md:text-sm mb-1">Mihrab arch, tight weave</div>
                    <div class="text-green-400 font-bold text-sm md:text-base">$5K-$40K</div>
                </div>
                <div class="bg-black bg-opacity-30 p-3 md:p-4 rounded-lg">
                    <div class="text-carpet-gold font-bold text-base md:text-lg mb-1">üåπ Chiprovtsi</div>
                    <div class="text-xs md:text-sm mb-1">Reversible UNESCO</div>
                    <div class="text-green-400 font-bold text-sm md:text-base">$2K-$40K</div>
                </div>
                <div class="bg-black bg-opacity-30 p-3 md:p-4 rounded-lg">
                    <div class="text-carpet-gold font-bold text-base md:text-lg mb-1">üíé Kuba/Chi-Chi</div>
                    <div class="text-xs md:text-sm mb-1">150-250 KPSI fine weave</div>
                    <div class="text-green-400 font-bold text-sm md:text-base">$10K-$60K</div>
                </div>
                <div class="bg-black bg-opacity-30 p-3 md:p-4 rounded-lg">
                    <div class="text-carpet-gold font-bold text-base md:text-lg mb-1">üìú Inscriptions</div>
                    <div class="text-xs md:text-sm mb-1">Armenian/Georgian dates</div>
                    <div class="text-green-400 font-bold text-sm md:text-base">+40-60% value</div>
                </div>
                <div class="bg-black bg-opacity-30 p-3 md:p-4 rounded-lg">
                    <div class="text-carpet-gold font-bold text-base md:text-lg mb-1">üß∂ Wool+Natural</div>
                    <div class="text-xs md:text-sm mb-1">Pre-1860s technology</div>
                    <div class="text-green-400 font-bold text-sm md:text-base">$15K-$80K+</div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap gap-2 mb-4 md:mb-6">
            <button onclick="switchTab('quick-id')" class="tab-btn active px-3 md:px-6 py-2 md:py-3 bg-carpet-medium text-white rounded-lg text-sm md:text-base font-semibold transition-all hover:bg-carpet-light">
                Quick ID
            </button>
            <button onclick="switchTab('database')" class="tab-btn px-3 md:px-6 py-2 md:py-3 bg-carpet-medium text-white rounded-lg text-sm md:text-base font-semibold transition-all hover:bg-carpet-light">
                üì∏ Fragments
            </button>
            <button onclick="switchTab('vendors')" class="tab-btn px-3 md:px-6 py-2 md:py-3 bg-carpet-medium text-white rounded-lg text-sm md:text-base font-semibold transition-all hover:bg-carpet-light">
                ü§ù Vendors
            </button>
            <button onclick="switchTab('search')" class="tab-btn px-3 md:px-6 py-2 md:py-3 bg-carpet-medium text-white rounded-lg text-sm md:text-base font-semibold transition-all hover:bg-carpet-light">
                Search
            </button>
            <button onclick="switchTab('symbols')" class="tab-btn px-3 md:px-6 py-2 md:py-3 bg-carpet-medium text-white rounded-lg text-sm md:text-base font-semibold transition-all hover:bg-carpet-light">
                Symbols
            </button>
            <button onclick="switchTab('regions')" class="tab-btn px-3 md:px-6 py-2 md:py-3 bg-carpet-medium text-white rounded-lg text-sm md:text-base font-semibold transition-all hover:bg-carpet-light">
                Regions
            </button>
            <button onclick="switchTab('dating')" class="tab-btn px-3 md:px-6 py-2 md:py-3 bg-carpet-medium text-white rounded-lg text-sm md:text-base font-semibold transition-all hover:bg-carpet-light">
                Dating
            </button>
        </div>

        <!-- FRAGMENT DATABASE TAB -->
        <div id="database" class="tab-content hidden">
            <div class="bg-carpet-medium p-4 md:p-6 rounded-xl shadow-xl">
                
                <!-- Header with stats -->
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-carpet-gold">üì∏ Fragment Database</h2>
                        <div id="dbStats" class="text-xs md:text-sm text-gray-400 mt-1">Loading...</div>
                    </div>
                    <button onclick="exportDatabase()" class="bg-carpet-bronze hover:bg-carpet-copper px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-all">
                        ‚¨á Export
                    </button>
                </div>

                <!-- Add Fragment Button -->
                <button onclick="showAddFragment()" class="w-full bg-gradient-to-r from-green-700 to-green-600 text-white py-4 rounded-xl text-base md:text-lg font-bold mb-4 hover:shadow-xl transition-all">
                    üì∑ + Add Fragment
                </button>

                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button onclick="filterFragments('all')" class="filter-status-btn active px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        All
                    </button>
                    <button onclick="filterFragments('owned')" class="filter-status-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        ‚úì Owned
                    </button>
                    <button onclick="filterFragments('passed')" class="filter-status-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        ‚úó Passed
                    </button>
                    <button onclick="filterFragments('considering')" class="filter-status-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        ? Considering
                    </button>
                    <button onclick="filterFragments('reference')" class="filter-status-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        üìö Reference
                    </button>
                </div>

                <!-- Gallery Grid -->
                <div id="fragmentGallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                    <!-- Fragments will be rendered here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12 text-gray-400">
                    <div class="text-4xl md:text-6xl mb-4">üì∏</div>
                    <div class="text-base md:text-lg font-bold mb-2">No Fragments Yet</div>
                    <div class="text-xs md:text-sm">Start building your collection by adding your first fragment!</div>
                </div>
            </div>

            <!-- Add/Edit Fragment Modal -->
            <div id="fragmentModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 overflow-y-auto">
                <div class="min-h-screen px-4 py-8 flex items-center justify-center">
                    <div class="bg-carpet-dark p-4 md:p-6 rounded-xl max-w-2xl w-full shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg md:text-xl font-bold text-carpet-gold" id="modalTitle">Add Fragment</h3>
                            <button onclick="closeFragmentModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>

                        <form id="fragmentForm" class="space-y-4">
                            <!-- Photo Upload -->
                            <div>
                                <label class="block text-sm md:text-base font-bold mb-2">Photo:</label>
                                <input type="file" id="photoInput" accept="image/*" class="hidden">
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button" onclick="document.getElementById('photoInput').click()" class="w-full bg-carpet-bronze hover:bg-carpet-copper px-4 py-3 rounded-lg font-bold text-xs md:text-sm">
                                        üìÅ Choose Photo
                                    </button>
                                    <button type="button" onclick="takePhoto()" class="w-full bg-green-700 hover:bg-green-600 px-4 py-3 rounded-lg font-bold text-xs md:text-sm">
                                        üì∑ Take Photo
                                    </button>
                                </div>
                                <div class="text-xs text-gray-400 mt-1 text-center">Choose from gallery or take new photo</div>
                                <div id="photoPreview" class="mt-2 hidden">
                                    <img id="previewImg" class="w-full rounded-lg" />
                                </div>
                            </div>

                            <!-- Auto-filled -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Timestamp:</label>
                                    <input type="text" id="timestamp" readonly class="w-full p-2 rounded bg-carpet-light text-gray-400 text-xs md:text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Location:</label>
                                    <input type="text" id="gpsLocation" readonly class="w-full p-2 rounded bg-carpet-light text-gray-400 text-xs md:text-sm">
                                </div>
                            </div>

                            <!-- Region & Weave Type -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Region:</label>
                                    <select id="dbRegion" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                        <option value="">Select...</option>
                                        <option value="armenia">Armenia</option>
                                        <option value="azerbaijan">Azerbaijan</option>
                                        <option value="georgia">Georgia</option>
                                        <option value="albania">Albania</option>
                                        <option value="bulgaria">Bulgaria</option>
                                        <option value="unknown">Unknown</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Weave Type:</label>
                                    <select id="weaveType" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                        <option value="">Select...</option>
                                        <option value="pile">Knotted Pile</option>
                                        <option value="kilim">Kilim (Flat-weave)</option>
                                        <option value="soumak">Soumak</option>
                                        <option value="mixed">Mixed Technique</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Symbols (multi-select checkboxes) -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-2">Symbols Present:</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs md:text-sm">
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="dragon" class="mr-2"> Dragon</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="eagle" class="mr-2"> Eagle</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="prayer" class="mr-2"> Prayer Niche</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="cross" class="mr-2"> Cross</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="rose" class="mr-2"> Rose</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="bird" class="mr-2"> Bird</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="animal" class="mr-2"> Animal</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="geometric" class="mr-2"> Geometric</label>
                                    <label class="flex items-center"><input type="checkbox" name="symbols" value="floral" class="mr-2"> Floral</label>
                                </div>
                            </div>

                            <!-- Status & Price -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Status:</label>
                                    <select id="status" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                        <option value="owned">‚úì Owned</option>
                                        <option value="passed">‚úó Passed</option>
                                        <option value="considering">? Considering</option>
                                        <option value="reference">üìö Reference</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Price Paid ($):</label>
                                    <input type="number" id="pricePaid" placeholder="Optional" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                            </div>

                            <!-- Size & KPSI -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Size (inches):</label>
                                    <input type="text" id="size" placeholder="e.g. 6x8" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">
                                        KPSI (optional):
                                        <button type="button" onclick="showKPSICalculator()" class="text-carpet-gold hover:text-yellow-400 ml-1">
                                            üî¢ Calculator
                                        </button>
                                    </label>
                                    <input type="number" id="kpsi" placeholder="Leave blank if unsure" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                    <div class="text-xs text-gray-400 mt-1">Use calculator or skip if uncertain</div>
                                </div>
                            </div>

                            <!-- Vendor & Location -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Vendor:</label>
                                    <input type="text" id="vendor" placeholder="Optional" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Market/Location:</label>
                                    <input type="text" id="marketLocation" placeholder="e.g. Vernissage" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                            </div>

                            <!-- Condition -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Condition:</label>
                                <select id="condition" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                </select>
                            </div>

                            <!-- Notes -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Notes:</label>
                                <textarea id="notes" rows="3" placeholder="Observations, negotiations, authentication notes..." class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base"></textarea>
                            </div>

                            <!-- Tags -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Tags (comma-separated):</label>
                                <input type="text" id="tags" placeholder="e.g. karabakh, natural-dyes, abrash" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                            </div>

                            <!-- Submit -->
                            <div class="flex gap-3">
                                <button type="submit" class="flex-1 bg-gradient-to-r from-green-700 to-green-600 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-base">
                                    üíæ Save Fragment
                                </button>
                                <button type="button" onclick="closeFragmentModal()" class="px-6 bg-gray-700 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-base">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- View Fragment Detail Modal -->
            <div id="viewFragmentModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 overflow-y-auto">
                <div class="min-h-screen px-4 py-8 flex items-center justify-center">
                    <div class="bg-carpet-dark p-4 md:p-6 rounded-xl max-w-3xl w-full shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg md:text-xl font-bold text-carpet-gold">Fragment Details</h3>
                            <button onclick="closeViewModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div id="fragmentDetailContent">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPSI Calculator Modal -->
            <div id="kpsiCalculatorModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 overflow-y-auto">
                <div class="min-h-screen px-4 py-8 flex items-center justify-center">
                    <div class="bg-gradient-to-br from-carpet-dark to-carpet-medium p-6 rounded-xl max-w-2xl w-full shadow-2xl border-2 border-carpet-gold">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-carpet-gold">üî¢ KPSI Calculator</h3>
                            <button onclick="closeKPSICalculator()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>

                        <!-- Guide -->
                        <div class="bg-yellow-900 bg-opacity-30 p-4 rounded-lg mb-4 border border-yellow-600">
                            <div class="font-bold text-yellow-300 mb-2">üìè How to Count KPSI:</div>
                            <ol class="text-sm space-y-2 text-yellow-100">
                                <li><strong>1.</strong> Turn carpet over (back side)</li>
                                <li><strong>2.</strong> Use your phone ruler app or physical ruler</li>
                                <li><strong>3.</strong> Mark out a 1-inch square with your fingers</li>
                                <li><strong>4.</strong> Count knots going ACROSS (horizontal) = A</li>
                                <li><strong>5.</strong> Count knots going DOWN (vertical) = B</li>
                                <li><strong>6.</strong> Multiply: A √ó B = KPSI</li>
                            </ol>
                        </div>

                        <!-- Visual Guide -->
                        <div class="bg-carpet-dark p-4 rounded-lg mb-4">
                            <div class="font-bold mb-2">What You're Looking For:</div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="text-carpet-gold font-bold mb-1">On Pile Carpets:</div>
                                    <div class="text-xs">Turn over - you'll see grid of tiny "bumps". Each bump = 1 knot. Count bumps in 1" square.</div>
                                </div>
                                <div>
                                    <div class="text-carpet-gold font-bold mb-1">On Kilims:</div>
                                    <div class="text-xs">No knots! Kilims are flat-weave. KPSI doesn't apply - leave blank.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Calculator -->
                        <div class="bg-carpet-light p-4 rounded-lg mb-4">
                            <div class="font-bold mb-3">Quick Calculator:</div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm mb-1">Knots Horizontal (A):</label>
                                    <input type="number" id="kpsiHorizontal" placeholder="Count across" class="w-full p-3 rounded bg-carpet-dark text-white">
                                </div>
                                <div>
                                    <label class="block text-sm mb-1">Knots Vertical (B):</label>
                                    <input type="number" id="kpsiVertical" placeholder="Count down" class="w-full p-3 rounded bg-carpet-dark text-white">
                                </div>
                            </div>
                            <button onclick="calculateKPSI()" class="w-full bg-carpet-bronze hover:bg-carpet-copper text-white py-3 rounded-lg font-bold">
                                = Calculate KPSI
                            </button>
                            <div id="kpsiResult" class="hidden mt-3 p-3 bg-green-900 bg-opacity-40 rounded-lg border border-green-500">
                                <div class="text-center">
                                    <div class="text-sm text-gray-400">Your KPSI:</div>
                                    <div class="text-3xl font-bold text-green-400" id="kpsiValue"></div>
                                    <div class="text-sm mt-2" id="kpsiQuality"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Reference Guide -->
                        <div class="bg-carpet-dark p-4 rounded-lg mb-4">
                            <div class="font-bold mb-2">üìä KPSI Reference Guide:</div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Under 60 KPSI:</span>
                                    <span>Tribal/Nomadic (coarse but valuable if old)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">60-100 KPSI:</span>
                                    <span>Village quality (most Caucasian)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">100-150 KPSI:</span>
                                    <span>Workshop quality (good Shirvan)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">150-250 KPSI:</span>
                                    <span class="text-green-400 font-bold">Premium (Kuba, Chi-Chi) $$$$</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">250+ KPSI:</span>
                                    <span class="text-yellow-400 font-bold">Museum quality $$$$$</span>
                                </div>
                            </div>
                        </div>

                        <!-- Regional Typical KPSI -->
                        <div class="bg-carpet-dark p-4 rounded-lg mb-4">
                            <div class="font-bold mb-2">üåç Typical KPSI by Region:</div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="text-carpet-gold">Armenia (Kazak):</span>
                                    <span class="text-gray-300"> 40-80</span>
                                </div>
                                <div>
                                    <span class="text-carpet-gold">Armenia (Karabakh):</span>
                                    <span class="text-gray-300"> 80-140</span>
                                </div>
                                <div>
                                    <span class="text-carpet-gold">Azerbaijan (Shirvan):</span>
                                    <span class="text-gray-300"> 100-160</span>
                                </div>
                                <div>
                                    <span class="text-carpet-gold">Azerbaijan (Kuba):</span>
                                    <span class="text-green-400 font-bold"> 150-250+</span>
                                </div>
                                <div>
                                    <span class="text-carpet-gold">Georgia:</span>
                                    <span class="text-gray-300"> 60-100</span>
                                </div>
                                <div>
                                    <span class="text-carpet-gold">Albania:</span>
                                    <span class="text-gray-300"> 50-90</span>
                                </div>
                            </div>
                        </div>

                        <!-- Pro Tips -->
                        <div class="bg-blue-900 bg-opacity-30 p-4 rounded-lg mb-4 border border-blue-600">
                            <div class="font-bold text-blue-300 mb-2">üí° Pro Tips:</div>
                            <ul class="text-sm space-y-1 text-blue-100">
                                <li>‚Ä¢ Don't stress over exact count - even ¬±10 is fine</li>
                                <li>‚Ä¢ If you can't see individual knots clearly = probably 150+ KPSI (fine weave)</li>
                                <li>‚Ä¢ Kilims have NO KPSI (flat-weave, no knots) - leave blank</li>
                                <li>‚Ä¢ Soumak has NO KPSI (weft-wrapped, no knots) - leave blank</li>
                                <li>‚Ä¢ When in doubt, just note "fine", "medium", or "coarse" in notes</li>
                                <li>‚Ä¢ Use a magnifying glass or phone camera zoom for tiny knots</li>
                            </ul>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="useCalculatedKPSI()" class="flex-1 bg-green-700 hover:bg-green-600 text-white py-3 rounded-xl font-bold">
                                ‚úì Use This KPSI
                            </button>
                            <button onclick="closeKPSICalculator()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-xl font-bold">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VENDOR DATABASE TAB -->
        <div id="vendors" class="tab-content hidden">
            <div class="bg-carpet-medium p-4 md:p-6 rounded-xl shadow-xl">
                
                <!-- Header with stats -->
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-carpet-gold">ü§ù Vendor Network</h2>
                        <div id="vendorStats" class="text-xs md:text-sm text-gray-400 mt-1">Loading...</div>
                    </div>
                    <button onclick="exportVendors()" class="bg-carpet-bronze hover:bg-carpet-copper px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-all">
                        ‚¨á Export
                    </button>
                </div>

                <!-- Add Vendor Button -->
                <button onclick="showAddVendor()" class="w-full bg-gradient-to-r from-blue-700 to-blue-600 text-white py-4 rounded-xl text-base md:text-lg font-bold mb-4 hover:shadow-xl transition-all">
                    üë§ + Add Vendor
                </button>

                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button onclick="filterVendors('all')" class="filter-vendor-btn active px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        All
                    </button>
                    <button onclick="filterVendors('armenia')" class="filter-vendor-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        üá¶üá≤ Armenia
                    </button>
                    <button onclick="filterVendors('azerbaijan')" class="filter-vendor-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        üá¶üáø Azerbaijan
                    </button>
                    <button onclick="filterVendors('georgia')" class="filter-vendor-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        üá¨üá™ Georgia
                    </button>
                    <button onclick="filterVendors('other')" class="filter-vendor-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm font-semibold">
                        Other
                    </button>
                </div>

                <!-- Vendor Gallery Grid -->
                <div id="vendorGallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                    <!-- Vendors will be rendered here -->
                </div>

                <!-- Empty State -->
                <div id="vendorEmptyState" class="hidden text-center py-12 text-gray-400">
                    <div class="text-4xl md:text-6xl mb-4">ü§ù</div>
                    <div class="text-base md:text-lg font-bold mb-2">No Vendors Yet</div>
                    <div class="text-xs md:text-sm">Start building your network by adding your first vendor contact!</div>
                </div>
            </div>

            <!-- Add/Edit Vendor Modal -->
            <div id="vendorModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 overflow-y-auto">
                <div class="min-h-screen px-4 py-8 flex items-center justify-center">
                    <div class="bg-carpet-dark p-4 md:p-6 rounded-xl max-w-2xl w-full shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg md:text-xl font-bold text-carpet-gold" id="vendorModalTitle">Add Vendor</h3>
                            <button onclick="closeVendorModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>

                        <form id="vendorForm" class="space-y-4">
                            <!-- Photo Upload -->
                            <div>
                                <label class="block text-sm md:text-base font-bold mb-2">Photo (Optional):</label>
                                <input type="file" id="vendorPhotoInput" accept="image/*" class="hidden">
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button" onclick="document.getElementById('vendorPhotoInput').click()" class="w-full bg-carpet-bronze hover:bg-carpet-copper px-4 py-3 rounded-lg font-bold text-xs md:text-sm">
                                        üìÅ Choose Photo
                                    </button>
                                    <button type="button" onclick="takeVendorPhoto()" class="w-full bg-green-700 hover:bg-green-600 px-4 py-3 rounded-lg font-bold text-xs md:text-sm">
                                        üì∑ Take Photo
                                    </button>
                                </div>
                                <div class="text-xs text-gray-400 mt-1 text-center">Ask permission before photographing</div>
                                <div id="vendorPhotoPreview" class="mt-2 hidden">
                                    <img id="vendorPreviewImg" class="w-full rounded-lg max-h-64 object-cover" />
                                </div>
                            </div>

                            <!-- Auto-filled -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Date Added:</label>
                                    <input type="text" id="vendorTimestamp" readonly class="w-full p-2 rounded bg-carpet-light text-gray-400 text-xs md:text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">GPS Location:</label>
                                    <input type="text" id="vendorGPS" readonly class="w-full p-2 rounded bg-carpet-light text-gray-400 text-xs md:text-sm">
                                </div>
                            </div>

                            <!-- Basic Info -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Vendor Name: *</label>
                                <input type="text" id="vendorName" required placeholder="e.g. Armen" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Country:</label>
                                    <select id="vendorCountry" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                        <option value="">Select...</option>
                                        <option value="armenia">üá¶üá≤ Armenia</option>
                                        <option value="azerbaijan">üá¶üáø Azerbaijan</option>
                                        <option value="georgia">üá¨üá™ Georgia</option>
                                        <option value="albania">üá¶üá± Albania</option>
                                        <option value="bulgaria">üáßüá¨ Bulgaria</option>
                                        <option value="turkey">üáπüá∑ Turkey</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">City/Market:</label>
                                    <input type="text" id="vendorCity" placeholder="e.g. Vernissage, Yerevan" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                            </div>

                            <!-- Contact Info -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Phone:</label>
                                    <input type="tel" id="vendorPhone" placeholder="+374..." class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">WhatsApp/Telegram:</label>
                                    <input type="text" id="vendorMessaging" placeholder="Same or different" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Social Media:</label>
                                <input type="text" id="vendorSocial" placeholder="Instagram, Facebook, etc." class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                            </div>

                            <!-- Specialties -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-2">Specialties:</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs md:text-sm">
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="armenian" class="mr-2"> Armenian</label>
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="azerbaijani" class="mr-2"> Azerbaijani</label>
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="georgian" class="mr-2"> Georgian</label>
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="kilims" class="mr-2"> Kilims</label>
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="pile" class="mr-2"> Pile Rugs</label>
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="antique" class="mr-2"> Antique</label>
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="fragments" class="mr-2"> Fragments</label>
                                    <label class="flex items-center"><input type="checkbox" name="vendorSpecialties" value="wholesale" class="mr-2"> Wholesale</label>
                                </div>
                            </div>

                            <!-- Relationship -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Relationship Quality:</label>
                                <select id="vendorRelationship" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                    <option value="new">üÜï New Contact</option>
                                    <option value="good">üëç Good Relationship</option>
                                    <option value="excellent">‚≠ê Excellent - Trusted</option>
                                    <option value="avoid">‚ö†Ô∏è Avoid</option>
                                </select>
                            </div>

                            <!-- Purchase History -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Times Purchased:</label>
                                    <input type="number" id="vendorPurchases" value="0" min="0" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-bold mb-1">Total Spent ($):</label>
                                    <input type="number" id="vendorSpent" value="0" min="0" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                                </div>
                            </div>

                            <!-- Notes -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Notes:</label>
                                <textarea id="vendorNotes" rows="3" placeholder="Quality, pricing strategy, negotiation style, inventory notes, best days to visit..." class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base"></textarea>
                            </div>

                            <!-- Tags -->
                            <div>
                                <label class="block text-xs md:text-sm font-bold mb-1">Tags (comma-separated):</label>
                                <input type="text" id="vendorTags" placeholder="e.g. fair-prices, speaks-english, family-business" class="w-full p-2 md:p-3 rounded bg-carpet-light text-white text-sm md:text-base">
                            </div>

                            <!-- Submit -->
                            <div class="flex gap-3">
                                <button type="submit" class="flex-1 bg-gradient-to-r from-blue-700 to-blue-600 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-base">
                                    üíæ Save Vendor
                                </button>
                                <button type="button" onclick="closeVendorModal()" class="px-6 bg-gray-700 text-white py-3 md:py-4 rounded-xl font-bold text-sm md:text-base">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- View Vendor Detail Modal -->
            <div id="viewVendorModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 overflow-y-auto">
                <div class="min-h-screen px-4 py-8 flex items-center justify-center">
                    <div class="bg-carpet-dark p-4 md:p-6 rounded-xl max-w-3xl w-full shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg md:text-xl font-bold text-carpet-gold">Vendor Details</h3>
                            <button onclick="closeViewVendorModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div id="vendorDetailContent">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUICK ID TAB -->
        <div id="quick-id" class="tab-content active fade-in">
            <div class="bg-gradient-to-br from-carpet-medium to-carpet-dark p-4 md:p-8 rounded-xl md:rounded-2xl border-4 border-carpet-bronze shadow-xl">
                <h2 class="text-xl md:text-3xl font-bold text-carpet-gold mb-4 md:mb-6">‚ö° Quick Fragment Identifier</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm md:text-base font-bold mb-2">Region:</label>
                        <select id="region" class="w-full p-3 md:p-4 rounded-lg bg-carpet-dark border-2 border-carpet-light text-white text-sm md:text-base">
                            <option value="">Select region...</option>
                            <option value="armenia">Armenia</option>
                            <option value="azerbaijan">Azerbaijan</option>
                            <option value="georgia">Georgia</option>
                            <option value="albania">Albania</option>
                            <option value="bulgaria">Bulgaria</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm md:text-base font-bold mb-2">Primary Colors:</label>
                        <select id="colors" class="w-full p-3 md:p-4 rounded-lg bg-carpet-dark border-2 border-carpet-light text-white text-sm md:text-base">
                            <option value="">Select colors...</option>
                            <option value="red-blue">Deep reds with indigo blues</option>
                            <option value="rust-cream">Rust, cream, brown earth tones</option>
                            <option value="vibrant">Vibrant reds, yellows, greens</option>
                            <option value="muted">Muted pastels, natural dyes</option>
                            <option value="black-white">Black, white, natural wool</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm md:text-base font-bold mb-2">Knot Density (KPSI):</label>
                        <select id="knotDensity" class="w-full p-3 md:p-4 rounded-lg bg-carpet-dark border-2 border-carpet-light text-white text-sm md:text-base">
                            <option value="">Select density...</option>
                            <option value="low">Low (40-80 KPSI)</option>
                            <option value="medium">Medium (80-150 KPSI)</option>
                            <option value="high">High (150-300 KPSI)</option>
                            <option value="very-high">Very High (300+ KPSI)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm md:text-base font-bold mb-2">Symbols/Motifs:</label>
                        <textarea id="symbols" rows="3" class="w-full p-3 md:p-4 rounded-lg bg-carpet-dark border-2 border-carpet-light text-white text-sm md:text-base" placeholder="dragon, prayer niche, geometric medallions, etc."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm md:text-base font-bold mb-2">Weaving Technique:</label>
                        <select id="technique" class="w-full p-3 md:p-4 rounded-lg bg-carpet-dark border-2 border-carpet-light text-white text-sm md:text-base">
                            <option value="">Select technique...</option>
                            <option value="pile">Knotted pile</option>
                            <option value="kilim">Flat-weave kilim</option>
                            <option value="soumak">Soumak (weft wrapping)</option>
                            <option value="mixed">Mixed technique</option>
                        </select>
                    </div>

                    <button onclick="identifyFragment()" class="w-full bg-gradient-to-r from-carpet-bronze to-carpet-copper text-white py-4 md:py-5 rounded-xl text-base md:text-lg font-bold hover:shadow-2xl transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        üîç Identify Fragment
                    </button>

                    <div id="resultBox" class="hidden mt-6 bg-carpet-light p-4 md:p-6 rounded-xl border-4 border-carpet-gold"></div>
                </div>
            </div>
        </div>

        <!-- SEARCH TAB -->
        <div id="search" class="tab-content hidden">
            <div class="bg-carpet-medium p-4 md:p-6 rounded-xl shadow-xl">
                <h2 class="text-xl md:text-2xl font-bold text-carpet-gold mb-4">üîç Global Search</h2>
                
                <input type="text" id="searchInput" 
                       placeholder="Search: dragon, prayer, 1850-1920, chiprovtsi, natural dyes..." 
                       class="w-full p-4 text-base rounded-lg bg-carpet-dark border-2 border-carpet-light text-white mb-3"
                       onkeyup="performSearch()">
                
                <div class="text-xs md:text-sm text-gray-400 mb-4">
                    Examples: "dragon" ‚Ä¢ "prayer rug" ‚Ä¢ "chiprovtsi" ‚Ä¢ "pre-1900" ‚Ä¢ "shirvan" ‚Ä¢ "high value"
                </div>

                <!-- Search Results Navigation -->
                <div id="searchResultsNav" class="hidden sticky top-0 z-50 bg-gradient-to-r from-carpet-copper to-carpet-bronze p-3 md:p-4 rounded-lg mb-4 shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span id="searchResultCount" class="text-sm md:text-base font-bold">Found 0 results</span>
                        <div class="flex gap-2">
                            <button onclick="previousResult()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 md:px-4 py-1 md:py-2 rounded text-xs md:text-sm font-bold">
                                ‚Üê Prev
                            </button>
                            <span id="currentResultNum" class="px-3 md:px-4 py-1 md:py-2 bg-black bg-opacity-20 rounded text-xs md:text-sm font-bold">
                                1 of 1
                            </span>
                            <button onclick="nextResult()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 md:px-4 py-1 md:py-2 rounded text-xs md:text-sm font-bold">
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                    <div id="currentResultInfo" class="text-xs md:text-sm opacity-90"></div>
                </div>

                <!-- Search results container -->
                <div id="searchResults" class="space-y-4"></div>
            </div>
        </div>

        <!-- SYMBOLS TAB -->
        <div id="symbols" class="tab-content hidden">
            <div class="bg-carpet-medium p-4 md:p-6 rounded-xl shadow-xl">
                <h2 class="text-xl md:text-2xl font-bold text-carpet-gold mb-4">Symbol Encyclopedia</h2>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <button onclick="filterSymbols('all')" class="filter-btn active px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm">All</button>
                    <button onclick="filterSymbols('very-high')" class="filter-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm">Very High $$$</button>
                    <button onclick="filterSymbols('high')" class="filter-btn px-3 md:px-4 py-2 bg-carpet-light text-white rounded-lg text-xs md:text-sm">High $$</button>
                </div>

                <div id="symbolsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                    <!-- Symbols will be rendered here -->
                </div>
            </div>
        </div>

        <!-- REGIONS TAB -->
        <div id="regions" class="tab-content hidden">
            <div class="space-y-4">
                <div class="bg-carpet-medium p-4 md:p-6 rounded-xl">
                    <h2 class="text-xl md:text-2xl font-bold text-carpet-gold mb-4">Regional Guides</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <button onclick="showRegion('armenia')" class="bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                            <div class="font-bold text-base md:text-lg mb-1">üá¶üá≤ Armenia</div>
                            <div class="text-xs md:text-sm opacity-80">Karabakh, Kazak, Dragons</div>
                        </button>
                        <button onclick="showRegion('azerbaijan')" class="bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                            <div class="font-bold text-base md:text-lg mb-1">üá¶üáø Azerbaijan</div>
                            <div class="text-xs md:text-sm opacity-80">Shirvan, Kuba, Prayer Rugs</div>
                        </button>
                        <button onclick="showRegion('georgia')" class="bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                            <div class="font-bold text-base md:text-lg mb-1">üá¨üá™ Georgia</div>
                            <div class="text-xs md:text-sm opacity-80">Karachov, Undervalued</div>
                        </button>
                        <button onclick="showRegion('albania')" class="bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                            <div class="font-bold text-base md:text-lg mb-1">üá¶üá± Albania</div>
                            <div class="text-xs md:text-sm opacity-80">Kilims, Emerging Market</div>
                        </button>
                        <button onclick="showRegion('bulgaria')" class="bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                            <div class="font-bold text-base md:text-lg mb-1">üáßüá¨ Bulgaria</div>
                            <div class="text-xs md:text-sm opacity-80">Chiprovtsi UNESCO</div>
                        </button>
                    </div>
                </div>
                <div id="regionDetail" class="bg-carpet-medium p-4 md:p-6 rounded-xl hidden"></div>
            </div>
        </div>

        <!-- DATING TAB -->
        <div id="dating" class="tab-content hidden">
            <div class="bg-carpet-medium p-4 md:p-6 rounded-xl">
                <h2 class="text-xl md:text-2xl font-bold text-carpet-gold mb-4">Authentication Tools</h2>
                <div class="space-y-4">
                    <button onclick="showAuthTool('checklist')" class="w-full bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                        <div class="font-bold text-base md:text-lg">üî¨ Authentication Checklist</div>
                        <div class="text-xs md:text-sm opacity-80">Point-based scoring system</div>
                    </button>
                    <button onclick="showAuthTool('age')" class="w-full bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                        <div class="font-bold text-base md:text-lg">üìÖ Age Estimator</div>
                        <div class="text-xs md:text-sm opacity-80">Date by dyes, foundation, design</div>
                    </button>
                    <button onclick="showAuthTool('redflags')" class="w-full bg-carpet-light hover:bg-carpet-copper p-4 rounded-lg text-left transition-all">
                        <div class="font-bold text-base md:text-lg">‚ö†Ô∏è Red Flags Guide</div>
                        <div class="text-xs md:text-sm opacity-80">Walk away indicators</div>
                    </button>
                </div>
                <div id="authToolContent" class="mt-4"></div>
            </div>
        </div>

    </div>

    <script>
        // PWA Installation
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.remove('hidden');
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.add('hidden');
            }
        }

        // Toggle Priority Buys Section
        function togglePriorityBuys() {
            const content = document.getElementById('priorityBuysContent');
            const toggle = document.getElementById('priorityToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                toggle.textContent = '‚ñº Hide';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂ Show';
            }
        }

        // ========================================
        // FRAGMENT DATABASE - IndexedDB Operations
        // ========================================
        
        let db;
        let currentFilter = 'all';
        let currentEditingId = null;
        
        // Initialize IndexedDB
        function initDB() {
            const request = indexedDB.open('CarpetFragmentDB', 1);
            
            request.onerror = () => console.error('Database failed to open');
            
            request.onsuccess = () => {
                db = request.result;
                loadFragments();
                updateStats();
            };
            
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                const objectStore = db.createObjectStore('fragments', { keyPath: 'id', autoIncrement: true });
                objectStore.createIndex('region', 'region', { unique: false });
                objectStore.createIndex('status', 'status', { unique: false });
                objectStore.createIndex('timestamp', 'timestamp', { unique: false });
            };
        }
        
        // Compress image to base64
        function compressImage(file, maxWidth = 1200) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to 80% quality JPEG
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Get user's GPS location
        async function getLocation() {
            return new Promise((resolve) => {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // Reverse geocode would go here - for now just coords
                            resolve(`${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
                        },
                        () => resolve('Yerevan, Armenia') // Fallback to user's set location
                    );
                } else {
                    resolve('Yerevan, Armenia');
                }
            });
        }
        
        // Show add fragment modal
        async function showAddFragment() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = 'Add Fragment';
            document.getElementById('fragmentForm').reset();
            document.getElementById('photoPreview').classList.add('hidden');
            
            // Auto-fill timestamp and location
            document.getElementById('timestamp').value = new Date().toLocaleString();
            document.getElementById('gpsLocation').value = await getLocation();
            
            document.getElementById('fragmentModal').classList.remove('hidden');
        }
        
        // Close modal
        function closeFragmentModal() {
            document.getElementById('fragmentModal').classList.add('hidden');
        }
        
        function closeViewModal() {
            document.getElementById('viewFragmentModal').classList.add('hidden');
        }
        
        // Photo input handler
        document.addEventListener('DOMContentLoaded', () => {
            const photoInput = document.getElementById('photoInput');
            if (photoInput) {
                photoInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const compressed = await compressImage(file);
                        document.getElementById('previewImg').src = compressed;
                        document.getElementById('photoPreview').classList.remove('hidden');
                    }
                });
            }
            
            // Form submit
            const form = document.getElementById('fragmentForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveFragment();
                });
            }
            
            // Initialize database
            initDB();
        });
        
        // Save fragment to IndexedDB
        async function saveFragment() {
            const photo = document.getElementById('previewImg').src;
            if (!photo || photo === window.location.href) {
                alert('Please add a photo!');
                return;
            }
            
            const symbols = Array.from(document.querySelectorAll('input[name="symbols"]:checked'))
                .map(cb => cb.value);
            
            const fragment = {
                photo: photo,
                timestamp: document.getElementById('timestamp').value,
                gpsLocation: document.getElementById('gpsLocation').value,
                region: document.getElementById('dbRegion').value,
                weaveType: document.getElementById('weaveType').value,
                symbols: symbols,
                status: document.getElementById('status').value,
                pricePaid: parseFloat(document.getElementById('pricePaid').value) || null,
                size: document.getElementById('size').value,
                kpsi: parseInt(document.getElementById('kpsi').value) || null,
                vendor: document.getElementById('vendor').value,
                marketLocation: document.getElementById('marketLocation').value,
                condition: document.getElementById('condition').value,
                notes: document.getElementById('notes').value,
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t)
            };
            
            // Get smart suggestions before saving
            const suggestions = await analyzeFragment(fragment);
            
            // Show suggestions if any anomalies detected
            if (suggestions.warnings.length > 0 || suggestions.suggestions.length > 0) {
                const proceed = await showSmartSuggestions(fragment, suggestions);
                if (!proceed) return; // User cancelled
            }
            
            const transaction = db.transaction(['fragments'], 'readwrite');
            const objectStore = transaction.objectStore('fragments');
            
            if (currentEditingId) {
                fragment.id = currentEditingId;
                objectStore.put(fragment);
            } else {
                objectStore.add(fragment);
            }
            
            transaction.oncomplete = () => {
                closeFragmentModal();
                loadFragments();
                updateStats();
            };
        }
        
        // ========================================
        // SMART ANALYSIS ENGINE
        // ========================================
        
        // Analyze fragment against database patterns
        async function analyzeFragment(newFragment) {
            return new Promise((resolve) => {
                const transaction = db.transaction(['fragments'], 'readonly');
                const objectStore = transaction.objectStore('fragments');
                const request = objectStore.getAll();
                
                request.onsuccess = () => {
                    const existingFragments = request.result;
                    const analysis = {
                        warnings: [],
                        suggestions: [],
                        confidence: 'medium',
                        similarFragments: []
                    };
                    
                    if (existingFragments.length < 3) {
                        // Not enough data yet
                        analysis.confidence = 'low';
                        resolve(analysis);
                        return;
                    }
                    
                    // Build pattern database from existing fragments
                    const patterns = buildPatterns(existingFragments);
                    
                    // Check for anomalies
                    checkSymbolRegionMatch(newFragment, patterns, analysis);
                    checkWeaveTypeMatch(newFragment, patterns, analysis);
                    checkPriceAnomaly(newFragment, patterns, analysis);
                    checkKPSIMatch(newFragment, patterns, analysis);
                    findSimilarFragments(newFragment, existingFragments, analysis);
                    suggestMissingSymbols(newFragment, patterns, analysis);
                    
                    // Calculate confidence
                    if (analysis.warnings.length === 0) {
                        analysis.confidence = 'high';
                    } else if (analysis.warnings.length <= 2) {
                        analysis.confidence = 'medium';
                    } else {
                        analysis.confidence = 'low';
                    }
                    
                    resolve(analysis);
                };
            });
        }
        
        // Build pattern database from existing fragments
        function buildPatterns(fragments) {
            const patterns = {
                regionSymbols: {}, // Which symbols appear with which regions
                regionWeave: {},   // Which weave types appear with which regions
                regionKPSI: {},    // KPSI ranges by region
                regionPrices: {},  // Price ranges by region
                symbolCombos: {},  // Common symbol combinations
                weaveKPSI: {}      // KPSI by weave type
            };
            
            fragments.forEach(f => {
                if (!f.region) return;
                
                // Track region-symbol patterns
                if (!patterns.regionSymbols[f.region]) {
                    patterns.regionSymbols[f.region] = {};
                }
                f.symbols.forEach(s => {
                    patterns.regionSymbols[f.region][s] = (patterns.regionSymbols[f.region][s] || 0) + 1;
                });
                
                // Track region-weave patterns
                if (f.weaveType) {
                    if (!patterns.regionWeave[f.region]) {
                        patterns.regionWeave[f.region] = {};
                    }
                    patterns.regionWeave[f.region][f.weaveType] = (patterns.regionWeave[f.region][f.weaveType] || 0) + 1;
                }
                
                // Track KPSI ranges
                if (f.kpsi) {
                    if (!patterns.regionKPSI[f.region]) {
                        patterns.regionKPSI[f.region] = [];
                    }
                    patterns.regionKPSI[f.region].push(f.kpsi);
                }
                
                // Track price ranges
                if (f.pricePaid) {
                    if (!patterns.regionPrices[f.region]) {
                        patterns.regionPrices[f.region] = [];
                    }
                    patterns.regionPrices[f.region].push(f.pricePaid);
                }
                
                // Track symbol combinations
                const key = f.symbols.sort().join(',');
                patterns.symbolCombos[key] = (patterns.symbolCombos[key] || 0) + 1;
            });
            
            return patterns;
        }
        
        // Check if symbols match typical region patterns
        function checkSymbolRegionMatch(fragment, patterns, analysis) {
            if (!fragment.region || fragment.symbols.length === 0) return;
            
            const regionSymbols = patterns.regionSymbols[fragment.region];
            if (!regionSymbols) return; // No data for this region yet
            
            const totalRegionFragments = Object.values(regionSymbols).reduce((a, b) => a + b, 0);
            
            fragment.symbols.forEach(symbol => {
                const count = regionSymbols[symbol] || 0;
                const frequency = count / totalRegionFragments;
                
                if (frequency < 0.1 && count > 0) {
                    // Rare but seen before
                    analysis.suggestions.push(`‚ö†Ô∏è ${symbol} is uncommon for ${fragment.region} (seen in ${Math.round(frequency * 100)}% of your ${fragment.region} fragments)`);
                } else if (count === 0 && totalRegionFragments > 5) {
                    // Never seen this combo before
                    analysis.warnings.push(`üö® ${symbol} has NEVER appeared in your ${fragment.region} fragments - double check region or symbol!`);
                }
            });
            
            // Suggest common symbols you might have missed
            const commonSymbols = Object.entries(regionSymbols)
                .filter(([sym, count]) => count / totalRegionFragments > 0.4)
                .map(([sym]) => sym);
            
            const missingCommon = commonSymbols.filter(s => !fragment.symbols.includes(s));
            if (missingCommon.length > 0) {
                analysis.suggestions.push(`üí° In your ${fragment.region} fragments, you usually also see: ${missingCommon.join(', ')} - check if present?`);
            }
        }
        
        // Check if weave type matches region
        function checkWeaveTypeMatch(fragment, patterns, analysis) {
            if (!fragment.region || !fragment.weaveType) return;
            
            const regionWeave = patterns.regionWeave[fragment.region];
            if (!regionWeave) return;
            
            const totalCount = Object.values(regionWeave).reduce((a, b) => a + b, 0);
            const thisWeaveCount = regionWeave[fragment.weaveType] || 0;
            
            if (thisWeaveCount === 0 && totalCount > 3) {
                analysis.warnings.push(`üö® You've never logged ${fragment.weaveType} from ${fragment.region} before - verify weave type!`);
            }
        }
        
        // Check if price is anomalous
        function checkPriceAnomaly(fragment, patterns, analysis) {
            if (!fragment.region || !fragment.pricePaid) return;
            
            const regionPrices = patterns.regionPrices[fragment.region];
            if (!regionPrices || regionPrices.length < 3) return;
            
            const avg = regionPrices.reduce((a, b) => a + b, 0) / regionPrices.length;
            const max = Math.max(...regionPrices);
            const min = Math.min(...regionPrices);
            
            if (fragment.pricePaid > max * 1.5) {
                analysis.warnings.push(`üí∞ Price ($${fragment.pricePaid}) is MUCH higher than your usual ${fragment.region} range ($${min}-$${max}, avg $${Math.round(avg)}) - make sure it's worth it!`);
            } else if (fragment.pricePaid < min * 0.5 && fragment.pricePaid > 0) {
                analysis.suggestions.push(`üéØ Great deal! Price ($${fragment.pricePaid}) is well below your usual ${fragment.region} range ($${min}-$${max})`);
            }
        }
        
        // Check if KPSI matches expectations
        function checkKPSIMatch(fragment, patterns, analysis) {
            if (!fragment.region || !fragment.kpsi) return;
            
            const regionKPSI = patterns.regionKPSI[fragment.region];
            if (!regionKPSI || regionKPSI.length < 3) return;
            
            const avg = regionKPSI.reduce((a, b) => a + b, 0) / regionKPSI.length;
            const max = Math.max(...regionKPSI);
            const min = Math.min(...regionKPSI);
            
            if (fragment.kpsi > max * 1.3) {
                analysis.suggestions.push(`‚ú® Exceptionally fine weaving! KPSI (${fragment.kpsi}) is higher than your usual ${fragment.region} range (${min}-${max}, avg ${Math.round(avg)})`);
            } else if (fragment.kpsi < min * 0.7) {
                analysis.warnings.push(`‚ö†Ô∏è KPSI (${fragment.kpsi}) is lower than your usual ${fragment.region} fragments (${min}-${max}) - check if it's really ${fragment.region}?`);
            }
        }
        
        // Find similar fragments in database
        function findSimilarFragments(fragment, allFragments, analysis) {
            const similar = allFragments.filter(f => {
                if (f.region !== fragment.region) return false;
                
                const sharedSymbols = fragment.symbols.filter(s => f.symbols.includes(s));
                return sharedSymbols.length >= 2; // At least 2 shared symbols
            }).slice(0, 3); // Top 3
            
            analysis.similarFragments = similar;
            
            if (similar.length > 0) {
                analysis.suggestions.push(`üîç Found ${similar.length} similar fragment(s) in your database - view details for comparison`);
            }
        }
        
        // Suggest symbols based on what usually appears together
        function suggestMissingSymbols(fragment, patterns, analysis) {
            if (fragment.symbols.length === 0) return;
            
            // Look for patterns: if symbol A appears, symbol B often appears too
            const symbolPairs = {};
            Object.keys(patterns.symbolCombos).forEach(combo => {
                const symbols = combo.split(',');
                symbols.forEach(s1 => {
                    symbols.forEach(s2 => {
                        if (s1 !== s2) {
                            const key = `${s1}->${s2}`;
                            symbolPairs[key] = (symbolPairs[key] || 0) + 1;
                        }
                    });
                });
            });
            
            // Check if any of user's selected symbols strongly correlate with others
            fragment.symbols.forEach(selectedSymbol => {
                Object.keys(symbolPairs).forEach(pair => {
                    const [from, to] = pair.split('->');
                    if (from === selectedSymbol && !fragment.symbols.includes(to)) {
                        const strength = symbolPairs[pair];
                        if (strength >= 3) { // Appears together in 3+ fragments
                            analysis.suggestions.push(`üí° When you've seen ${from}, you usually also noted ${to} - is it present?`);
                        }
                    }
                });
            });
        }
        
        // Show smart suggestions modal
        function showSmartSuggestions(fragment, analysis) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 overflow-y-auto';
                modal.innerHTML = `
                    <div class="min-h-screen px-4 py-8 flex items-center justify-center">
                        <div class="bg-gradient-to-br from-carpet-dark to-carpet-medium p-6 rounded-xl max-w-2xl w-full shadow-2xl border-4 ${
                            analysis.confidence === 'high' ? 'border-green-500' : 
                            analysis.confidence === 'medium' ? 'border-yellow-500' : 
                            'border-red-500'
                        }">
                            <div class="text-center mb-6">
                                <div class="text-4xl mb-2">${
                                    analysis.confidence === 'high' ? '‚úÖ' : 
                                    analysis.confidence === 'medium' ? '‚ö†Ô∏è' : 
                                    'üö®'
                                }</div>
                                <h3 class="text-2xl font-bold text-carpet-gold mb-2">Smart Analysis</h3>
                                <div class="text-sm ${
                                    analysis.confidence === 'high' ? 'text-green-400' : 
                                    analysis.confidence === 'medium' ? 'text-yellow-400' : 
                                    'text-red-400'
                                }">
                                    Confidence: ${analysis.confidence.toUpperCase()}
                                </div>
                            </div>
                            
                            ${analysis.warnings.length > 0 ? `
                            <div class="bg-red-900 bg-opacity-50 p-4 rounded-lg mb-4 border-2 border-red-500">
                                <div class="font-bold mb-2 text-red-300">‚ö†Ô∏è Warnings (based on your database):</div>
                                <ul class="space-y-2 text-sm">
                                    ${analysis.warnings.map(w => `<li class="text-red-200">‚Ä¢ ${w}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            ${analysis.suggestions.length > 0 ? `
                            <div class="bg-yellow-900 bg-opacity-30 p-4 rounded-lg mb-4 border border-yellow-600">
                                <div class="font-bold mb-2 text-yellow-300">üí° Suggestions:</div>
                                <ul class="space-y-2 text-sm">
                                    ${analysis.suggestions.map(s => `<li class="text-yellow-100">‚Ä¢ ${s}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            ${analysis.similarFragments.length > 0 ? `
                            <div class="bg-blue-900 bg-opacity-30 p-4 rounded-lg mb-4 border border-blue-600">
                                <div class="font-bold mb-2 text-blue-300">üîç Similar in Your Database:</div>
                                <div class="grid grid-cols-3 gap-2">
                                    ${analysis.similarFragments.map(f => `
                                        <div class="bg-carpet-light rounded overflow-hidden">
                                            <img src="${f.photo}" class="w-full h-20 object-cover">
                                            <div class="p-1 text-xs">${f.region} - $${f.pricePaid || '?'}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="text-xs text-gray-400 mb-4 text-center italic">
                                These insights are based on ${analysis.confidence === 'low' ? 'limited' : 'your'} database patterns. Use your expert judgment!
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="this.closest('.fixed').remove(); window.fragmentSaveResolve(true)" 
                                        class="flex-1 bg-green-700 hover:bg-green-600 text-white py-4 rounded-xl font-bold text-lg">
                                    ‚úì Save Anyway
                                </button>
                                <button onclick="this.closest('.fixed').remove(); window.fragmentSaveResolve(false)" 
                                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-xl font-bold text-lg">
                                    ‚úó Review First
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Set up promise resolution
                window.fragmentSaveResolve = (proceed) => {
                    modal.remove();
                    delete window.fragmentSaveResolve;
                    resolve(proceed);
                };
            });
        }
        
        // ========================================
        // END SMART ANALYSIS ENGINE
        // ========================================

        // ========================================
        // KPSI CALCULATOR
        // ========================================
        
        let calculatedKPSI = null;
        
        // Trigger camera specifically
        function takePhoto() {
            const input = document.getElementById('photoInput');
            input.setAttribute('capture', 'environment');
            input.click();
            // Remove capture attribute after click so gallery still works
            setTimeout(() => input.removeAttribute('capture'), 100);
        }
        
        function showKPSICalculator() {
            document.getElementById('kpsiCalculatorModal').classList.remove('hidden');
            document.getElementById('kpsiResult').classList.add('hidden');
            document.getElementById('kpsiHorizontal').value = '';
            document.getElementById('kpsiVertical').value = '';
        }
        
        function closeKPSICalculator() {
            document.getElementById('kpsiCalculatorModal').classList.add('hidden');
        }
        
        function calculateKPSI() {
            const horizontal = parseInt(document.getElementById('kpsiHorizontal').value);
            const vertical = parseInt(document.getElementById('kpsiVertical').value);
            
            if (!horizontal || !vertical) {
                alert('Please enter both horizontal and vertical knot counts!');
                return;
            }
            
            calculatedKPSI = horizontal * vertical;
            document.getElementById('kpsiValue').textContent = calculatedKPSI;
            
            // Determine quality level
            let quality = '';
            let qualityColor = '';
            
            if (calculatedKPSI < 60) {
                quality = 'Tribal/Nomadic Quality - Coarse but authentic';
                qualityColor = 'text-yellow-400';
            } else if (calculatedKPSI < 100) {
                quality = 'Village Quality - Typical Caucasian';
                qualityColor = 'text-blue-400';
            } else if (calculatedKPSI < 150) {
                quality = 'Workshop Quality - Good Shirvan range';
                qualityColor = 'text-green-400';
            } else if (calculatedKPSI < 250) {
                quality = 'üéØ PREMIUM - Kuba/Chi-Chi quality! High value!';
                qualityColor = 'text-green-300 font-bold';
            } else {
                quality = 'üèÜ MUSEUM QUALITY - Extremely fine! Major find!';
                qualityColor = 'text-yellow-300 font-bold';
            }
            
            const qualityDiv = document.getElementById('kpsiQuality');
            qualityDiv.textContent = quality;
            qualityDiv.className = `text-sm mt-2 ${qualityColor}`;
            
            document.getElementById('kpsiResult').classList.remove('hidden');
        }
        
        function useCalculatedKPSI() {
            if (calculatedKPSI) {
                document.getElementById('kpsi').value = calculatedKPSI;
                closeKPSICalculator();
            }
        }
        
        // ========================================
        // END KPSI CALCULATOR
        // ========================================

        // ========================================
        // VENDOR DATABASE
        // ========================================
        
        let vendorDB;
        let currentVendorFilter = 'all';
        let currentEditingVendorId = null;
        
        // Initialize Vendor IndexedDB
        function initVendorDB() {
            const request = indexedDB.open('CarpetVendorDB', 1);
            
            request.onerror = () => console.error('Vendor database failed to open');
            
            request.onsuccess = () => {
                vendorDB = request.result;
                loadVendors();
                updateVendorStats();
            };
            
            request.onupgradeneeded = (e) => {
                vendorDB = e.target.result;
                const objectStore = vendorDB.createObjectStore('vendors', { keyPath: 'id', autoIncrement: true });
                objectStore.createIndex('country', 'country', { unique: false });
                objectStore.createIndex('relationship', 'relationship', { unique: false });
                objectStore.createIndex('timestamp', 'timestamp', { unique: false });
            };
        }
        
        // Trigger vendor camera
        function takeVendorPhoto() {
            const input = document.getElementById('vendorPhotoInput');
            input.setAttribute('capture', 'user'); // Front camera for selfie with vendor
            input.click();
            setTimeout(() => input.removeAttribute('capture'), 100);
        }
        
        // Show add vendor modal
        async function showAddVendor() {
            currentEditingVendorId = null;
            document.getElementById('vendorModalTitle').textContent = 'Add Vendor';
            document.getElementById('vendorForm').reset();
            document.getElementById('vendorPhotoPreview').classList.add('hidden');
            
            // Auto-fill timestamp and location
            document.getElementById('vendorTimestamp').value = new Date().toLocaleString();
            document.getElementById('vendorGPS').value = await getLocation();
            
            document.getElementById('vendorModal').classList.remove('hidden');
        }
        
        // Close modals
        function closeVendorModal() {
            document.getElementById('vendorModal').classList.add('hidden');
        }
        
        function closeViewVendorModal() {
            document.getElementById('viewVendorModal').classList.add('hidden');
        }
        
        // Photo input handler for vendors
        document.addEventListener('DOMContentLoaded', () => {
            const vendorPhotoInput = document.getElementById('vendorPhotoInput');
            if (vendorPhotoInput) {
                vendorPhotoInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const compressed = await compressImage(file, 800); // Smaller for vendor photos
                        document.getElementById('vendorPreviewImg').src = compressed;
                        document.getElementById('vendorPhotoPreview').classList.remove('hidden');
                    }
                });
            }
            
            // Form submit
            const vendorForm = document.getElementById('vendorForm');
            if (vendorForm) {
                vendorForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveVendor();
                });
            }
            
            // Initialize vendor database
            initVendorDB();
        });
        
        // Save vendor to IndexedDB
        async function saveVendor() {
            const vendorName = document.getElementById('vendorName').value;
            if (!vendorName) {
                alert('Please enter vendor name!');
                return;
            }
            
            const photo = document.getElementById('vendorPreviewImg').src || null;
            
            const specialties = Array.from(document.querySelectorAll('input[name="vendorSpecialties"]:checked'))
                .map(cb => cb.value);
            
            const vendor = {
                photo: photo,
                timestamp: document.getElementById('vendorTimestamp').value,
                gpsLocation: document.getElementById('vendorGPS').value,
                name: vendorName,
                country: document.getElementById('vendorCountry').value,
                city: document.getElementById('vendorCity').value,
                phone: document.getElementById('vendorPhone').value,
                messaging: document.getElementById('vendorMessaging').value,
                social: document.getElementById('vendorSocial').value,
                specialties: specialties,
                relationship: document.getElementById('vendorRelationship').value,
                purchases: parseInt(document.getElementById('vendorPurchases').value) || 0,
                totalSpent: parseFloat(document.getElementById('vendorSpent').value) || 0,
                notes: document.getElementById('vendorNotes').value,
                tags: document.getElementById('vendorTags').value.split(',').map(t => t.trim()).filter(t => t),
                lastContact: new Date().toISOString()
            };
            
            const transaction = vendorDB.transaction(['vendors'], 'readwrite');
            const objectStore = transaction.objectStore('vendors');
            
            if (currentEditingVendorId) {
                vendor.id = currentEditingVendorId;
                objectStore.put(vendor);
            } else {
                objectStore.add(vendor);
            }
            
            transaction.oncomplete = () => {
                closeVendorModal();
                loadVendors();
                updateVendorStats();
            };
        }
        
        // Load vendors from IndexedDB
        function loadVendors() {
            const transaction = vendorDB.transaction(['vendors'], 'readonly');
            const objectStore = transaction.objectStore('vendors');
            const request = objectStore.getAll();
            
            request.onsuccess = () => {
                const vendors = request.result;
                renderVendorGallery(vendors);
            };
        }
        
        // Filter vendors
        function filterVendors(country) {
            currentVendorFilter = country;
            
            // Update button states
            document.querySelectorAll('.filter-vendor-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-carpet-bronze');
            });
            event.target.classList.add('active', 'bg-carpet-bronze');
            
            const transaction = vendorDB.transaction(['vendors'], 'readonly');
            const objectStore = transaction.objectStore('vendors');
            
            if (country === 'all') {
                objectStore.getAll().onsuccess = (e) => renderVendorGallery(e.target.result);
            } else {
                const index = objectStore.index('country');
                index.getAll(country).onsuccess = (e) => renderVendorGallery(e.target.result);
            }
        }
        
        // Render vendor gallery
        function renderVendorGallery(vendors) {
            const gallery = document.getElementById('vendorGallery');
            const emptyState = document.getElementById('vendorEmptyState');
            
            if (vendors.length === 0) {
                gallery.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // Relationship emojis
            const relationshipEmoji = {
                'new': 'üÜï',
                'good': 'üëç',
                'excellent': '‚≠ê',
                'avoid': '‚ö†Ô∏è'
            };
            
            gallery.innerHTML = vendors.map(v => `
                <div onclick="viewVendor(${v.id})" class="bg-carpet-light rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-carpet-gold transition-all">
                    ${v.photo ? `
                        <img src="${v.photo}" class="w-full h-32 md:h-40 object-cover">
                    ` : `
                        <div class="w-full h-32 md:h-40 bg-carpet-dark flex items-center justify-center text-4xl">
                            üë§
                        </div>
                    `}
                    <div class="p-2 md:p-3">
                        <div class="text-sm md:text-base font-bold text-carpet-gold mb-1 truncate">
                            ${v.name}
                        </div>
                        <div class="text-xs text-gray-400 mb-1 truncate">${v.city || v.country || 'Location unknown'}</div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs">${relationshipEmoji[v.relationship] || 'üÜï'}</span>
                            <span class="text-xs text-green-400 font-bold">${v.purchases} buys</span>
                        </div>
                        ${v.specialties.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mt-2">
                            ${v.specialties.slice(0, 2).map(s => `<span class="text-xs bg-carpet-dark px-2 py-1 rounded">${s}</span>`).join('')}
                            ${v.specialties.length > 2 ? `<span class="text-xs text-gray-500">+${v.specialties.length - 2}</span>` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // View vendor details
        function viewVendor(id) {
            const transaction = vendorDB.transaction(['vendors'], 'readonly');
            const objectStore = transaction.objectStore('vendors');
            const request = objectStore.get(id);
            
            request.onsuccess = () => {
                const v = request.result;
                const content = document.getElementById('vendorDetailContent');
                
                const relationshipLabels = {
                    'new': 'üÜï New Contact',
                    'good': 'üëç Good Relationship',
                    'excellent': '‚≠ê Excellent - Trusted',
                    'avoid': '‚ö†Ô∏è Avoid'
                };
                
                content.innerHTML = `
                    ${v.photo ? `<img src="${v.photo}" class="w-full rounded-lg mb-4 max-h-96 object-cover">` : ''}
                    
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-carpet-gold mb-2">${v.name}</h3>
                        <div class="text-gray-400">${v.city ? v.city + ', ' : ''}${v.country || ''}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-xs text-gray-400">Relationship</div>
                            <div class="font-bold">${relationshipLabels[v.relationship]}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">Times Purchased</div>
                            <div class="font-bold">${v.purchases}</div>
                        </div>
                        ${v.totalSpent > 0 ? `
                        <div>
                            <div class="text-xs text-gray-400">Total Spent</div>
                            <div class="font-bold text-green-400">$${v.totalSpent.toLocaleString()}</div>
                        </div>
                        ` : ''}
                        ${v.phone ? `
                        <div>
                            <div class="text-xs text-gray-400">Phone</div>
                            <div class="font-bold"><a href="tel:${v.phone}" class="text-blue-400">${v.phone}</a></div>
                        </div>
                        ` : ''}
                        ${v.messaging ? `
                        <div>
                            <div class="text-xs text-gray-400">WhatsApp/Telegram</div>
                            <div class="font-bold">${v.messaging}</div>
                        </div>
                        ` : ''}
                        ${v.social ? `
                        <div>
                            <div class="text-xs text-gray-400">Social Media</div>
                            <div class="font-bold text-sm truncate">${v.social}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${v.specialties.length > 0 ? `
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Specialties</div>
                        <div class="flex flex-wrap gap-2">
                            ${v.specialties.map(s => `<span class="bg-carpet-bronze px-3 py-1 rounded-full text-sm">${s}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${v.notes ? `
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Notes</div>
                        <div class="bg-carpet-light p-3 rounded text-sm">${v.notes}</div>
                    </div>
                    ` : ''}
                    
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Contact Info & Location</div>
                        <div class="text-sm">${v.gpsLocation}</div>
                        <div class="text-xs text-gray-500">${v.timestamp}</div>
                    </div>
                    
                    ${v.tags.length > 0 ? `
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Tags</div>
                        <div class="flex flex-wrap gap-2">
                            ${v.tags.map(t => `<span class="text-xs bg-carpet-dark px-2 py-1 rounded">#${t}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="incrementVendorPurchase(${v.id})" class="flex-1 bg-green-700 hover:bg-green-600 text-white py-3 rounded-lg font-bold text-sm">
                            ‚úì Record Purchase
                        </button>
                        <button onclick="deleteVendor(${v.id})" class="flex-1 bg-red-700 hover:bg-red-600 text-white py-3 rounded-lg font-bold text-sm">
                            üóëÔ∏è Delete
                        </button>
                        <button onclick="closeViewVendorModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold text-sm">
                            Close
                        </button>
                    </div>
                `;
                
                document.getElementById('viewVendorModal').classList.remove('hidden');
            };
        }
        
        // Increment vendor purchase count
        function incrementVendorPurchase(id) {
            const transaction = vendorDB.transaction(['vendors'], 'readwrite');
            const objectStore = transaction.objectStore('vendors');
            const request = objectStore.get(id);
            
            request.onsuccess = () => {
                const vendor = request.result;
                vendor.purchases = (vendor.purchases || 0) + 1;
                vendor.lastContact = new Date().toISOString();
                objectStore.put(vendor);
            };
            
            transaction.oncomplete = () => {
                closeViewVendorModal();
                loadVendors();
                updateVendorStats();
                alert('Purchase recorded! ‚úì');
            };
        }
        
        // Delete vendor
        function deleteVendor(id) {
            if (!confirm('Are you sure you want to delete this vendor?')) return;
            
            const transaction = vendorDB.transaction(['vendors'], 'readwrite');
            const objectStore = transaction.objectStore('vendors');
            objectStore.delete(id);
            
            transaction.oncomplete = () => {
                closeViewVendorModal();
                loadVendors();
                updateVendorStats();
            };
        }
        
        // Update vendor stats
        function updateVendorStats() {
            const transaction = vendorDB.transaction(['vendors'], 'readonly');
            const objectStore = transaction.objectStore('vendors');
            const request = objectStore.getAll();
            
            request.onsuccess = () => {
                const vendors = request.result;
                const totalPurchases = vendors.reduce((sum, v) => sum + (v.purchases || 0), 0);
                const totalSpent = vendors.reduce((sum, v) => sum + (v.totalSpent || 0), 0);
                
                document.getElementById('vendorStats').textContent = 
                    `${vendors.length} vendors ‚Ä¢ ${totalPurchases} purchases ‚Ä¢ $${totalSpent.toLocaleString()} total spent`;
            };
        }
        
        // Export vendors as JSON
        function exportVendors() {
            const transaction = vendorDB.transaction(['vendors'], 'readonly');
            const objectStore = transaction.objectStore('vendors');
            const request = objectStore.getAll();
            
            request.onsuccess = () => {
                const data = {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    vendors: request.result
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carpet-vendors-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
        }
        
        // ========================================
        // END VENDOR DATABASE
        // ========================================
        
        // Load fragments from IndexedDB
        function loadFragments() {
            const transaction = db.transaction(['fragments'], 'readonly');
            const objectStore = transaction.objectStore('fragments');
            const request = objectStore.getAll();
            
            request.onsuccess = () => {
                const fragments = request.result;
                renderGallery(fragments);
            };
        }
        
        // Filter fragments
        function filterFragments(status) {
            currentFilter = status;
            
            // Update button states
            document.querySelectorAll('.filter-status-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-carpet-bronze');
            });
            event.target.classList.add('active', 'bg-carpet-bronze');
            
            const transaction = db.transaction(['fragments'], 'readonly');
            const objectStore = transaction.objectStore('fragments');
            
            if (status === 'all') {
                objectStore.getAll().onsuccess = (e) => renderGallery(e.target.result);
            } else {
                const index = objectStore.index('status');
                index.getAll(status).onsuccess = (e) => renderGallery(e.target.result);
            }
        }
        
        // Render gallery
        function renderGallery(fragments) {
            const gallery = document.getElementById('fragmentGallery');
            const emptyState = document.getElementById('emptyState');
            
            if (fragments.length === 0) {
                gallery.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            gallery.innerHTML = fragments.map(f => `
                <div onclick="viewFragment(${f.id})" class="bg-carpet-light rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-carpet-gold transition-all">
                    <img src="${f.photo}" class="w-full h-32 md:h-40 object-cover">
                    <div class="p-2 md:p-3">
                        <div class="text-xs md:text-sm font-bold text-carpet-gold mb-1">
                            ${f.region ? f.region.charAt(0).toUpperCase() + f.region.slice(1) : 'Unknown'}
                        </div>
                        <div class="text-xs text-gray-400 mb-1">${f.timestamp.split(',')[0]}</div>
                        ${f.pricePaid ? `<div class="text-xs text-green-400 font-bold">$${f.pricePaid}</div>` : ''}
                        <div class="flex flex-wrap gap-1 mt-2">
                            ${f.symbols.slice(0, 3).map(s => `<span class="text-xs bg-carpet-dark px-2 py-1 rounded">${s}</span>`).join('')}
                            ${f.symbols.length > 3 ? `<span class="text-xs text-gray-500">+${f.symbols.length - 3}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // View fragment details
        function viewFragment(id) {
            const transaction = db.transaction(['fragments'], 'readonly');
            const objectStore = transaction.objectStore('fragments');
            const request = objectStore.get(id);
            
            request.onsuccess = () => {
                const f = request.result;
                const content = document.getElementById('fragmentDetailContent');
                
                content.innerHTML = `
                    <img src="${f.photo}" class="w-full rounded-lg mb-4">
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-xs text-gray-400">Region</div>
                            <div class="font-bold">${f.region || 'Unknown'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">Weave Type</div>
                            <div class="font-bold">${f.weaveType || 'Unknown'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">Status</div>
                            <div class="font-bold">${f.status}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400">Condition</div>
                            <div class="font-bold">${f.condition}</div>
                        </div>
                        ${f.size ? `
                        <div>
                            <div class="text-xs text-gray-400">Size</div>
                            <div class="font-bold">${f.size}</div>
                        </div>
                        ` : ''}
                        ${f.kpsi ? `
                        <div>
                            <div class="text-xs text-gray-400">KPSI</div>
                            <div class="font-bold">${f.kpsi}</div>
                        </div>
                        ` : ''}
                        ${f.pricePaid ? `
                        <div>
                            <div class="text-xs text-gray-400">Price Paid</div>
                            <div class="font-bold text-green-400">$${f.pricePaid}</div>
                        </div>
                        ` : ''}
                        ${f.vendor ? `
                        <div>
                            <div class="text-xs text-gray-400">Vendor</div>
                            <div class="font-bold">${f.vendor}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Symbols Present</div>
                        <div class="flex flex-wrap gap-2">
                            ${f.symbols.map(s => `<span class="bg-carpet-bronze px-3 py-1 rounded-full text-sm">${s}</span>`).join('')}
                        </div>
                    </div>
                    
                    ${f.notes ? `
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Notes</div>
                        <div class="bg-carpet-light p-3 rounded text-sm">${f.notes}</div>
                    </div>
                    ` : ''}
                    
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Location & Time</div>
                        <div class="text-sm">${f.gpsLocation}</div>
                        <div class="text-xs text-gray-500">${f.timestamp}</div>
                    </div>
                    
                    ${f.tags.length > 0 ? `
                    <div class="mb-4">
                        <div class="text-xs text-gray-400 mb-1">Tags</div>
                        <div class="flex flex-wrap gap-2">
                            ${f.tags.map(t => `<span class="text-xs bg-carpet-dark px-2 py-1 rounded">#${t}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="deleteFragment(${f.id})" class="flex-1 bg-red-700 hover:bg-red-600 text-white py-3 rounded-lg font-bold">
                            üóëÔ∏è Delete
                        </button>
                        <button onclick="closeViewModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold">
                            Close
                        </button>
                    </div>
                `;
                
                document.getElementById('viewFragmentModal').classList.remove('hidden');
            };
        }
        
        // Delete fragment
        function deleteFragment(id) {
            if (!confirm('Are you sure you want to delete this fragment?')) return;
            
            const transaction = db.transaction(['fragments'], 'readwrite');
            const objectStore = transaction.objectStore('fragments');
            objectStore.delete(id);
            
            transaction.oncomplete = () => {
                closeViewModal();
                loadFragments();
                updateStats();
            };
        }
        
        // Update stats
        function updateStats() {
            const transaction = db.transaction(['fragments'], 'readonly');
            const objectStore = transaction.objectStore('fragments');
            const request = objectStore.getAll();
            
            request.onsuccess = () => {
                const fragments = request.result;
                const owned = fragments.filter(f => f.status === 'owned');
                const totalValue = owned.reduce((sum, f) => sum + (f.pricePaid || 0), 0);
                
                document.getElementById('dbStats').textContent = 
                    `${fragments.length} total ‚Ä¢ ${owned.length} owned ‚Ä¢ $${totalValue.toFixed(0)} invested`;
            };
        }
        
        // Export database as JSON
        function exportDatabase() {
            const transaction = db.transaction(['fragments'], 'readonly');
            const objectStore = transaction.objectStore('fragments');
            const request = objectStore.getAll();
            
            request.onsuccess = () => {
                const data = {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    fragments: request.result
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carpet-fragments-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
        }

        // ========================================
        // END FRAGMENT DATABASE
        // ========================================

        // Service Worker Registration with Update Detection
        const APP_VERSION = '2.0.0'; // UPDATE THIS NUMBER WHEN YOU MAKE CHANGES
        
        if ('serviceWorker' in navigator) {
            const sw = `
                const CACHE_NAME = 'carpet-expert-v${APP_VERSION}';
                const urlsToCache = ['./', 'index.html'];
                
                self.addEventListener('install', (event) => {
                    self.skipWaiting(); // Force new service worker to activate immediately
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                    );
                });
                
                self.addEventListener('activate', (event) => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName !== CACHE_NAME) {
                                        console.log('Deleting old cache:', cacheName);
                                        return caches.delete(cacheName); // Delete old caches
                                    }
                                })
                            );
                        })
                    );
                    return self.clients.claim(); // Take control immediately
                });
                
                self.addEventListener('fetch', (event) => {
                    // Network-first strategy for HTML files (always get fresh)
                    if (event.request.url.includes('index.html') || event.request.mode === 'navigate') {
                        event.respondWith(
                            fetch(event.request)
                                .then(response => {
                                    const responseClone = response.clone();
                                    caches.open(CACHE_NAME).then(cache => {
                                        cache.put(event.request, responseClone);
                                    });
                                    return response;
                                })
                                .catch(() => caches.match(event.request))
                        );
                    } else {
                        // Cache-first for other resources
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    }
                });
            `;
            const blob = new Blob([sw], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(registration => {
                // Force update check immediately
                registration.update();
                
                // Check for updates every 30 seconds while app is open
                setInterval(() => {
                    registration.update();
                }, 30000);
                
                // Listen for new service worker
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New version available!
                            showUpdateNotification();
                        }
                    });
                });
            });
            
            // Refresh page when new service worker takes control
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        }
        
        function showUpdateNotification() {
            const updateBanner = document.createElement('div');
            updateBanner.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #d2691e 0%, #8b4513 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 10000;
                text-align: center;
                max-width: 90%;
                animation: slideDown 0.3s ease;
            `;
            updateBanner.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">üéâ New Update Available!</div>
                <div style="font-size: 0.9em; margin-bottom: 12px;">v2.0.0 - Fragment Database + Smart Analysis</div>
                <button onclick="window.location.reload()" style="background: white; color: #8b4513; border: none; padding: 8px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    Update Now
                </button>
            `;
            document.body.appendChild(updateBanner);
        }

        // Manifest Generation with reliable icon
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 512;
        const ctx = canvas.getContext('2d');
        
        // Background gradient
        const bgGrad = ctx.createLinearGradient(0, 0, 512, 512);
        bgGrad.addColorStop(0, '#8b4513');
        bgGrad.addColorStop(1, '#d2691e');
        ctx.fillStyle = bgGrad;
        ctx.fillRect(0, 0, 512, 512);
        
        // Larger carpet base (centered and bigger)
        const carpetGrad = ctx.createLinearGradient(0, 60, 0, 452);
        carpetGrad.addColorStop(0, '#8b0000');
        carpetGrad.addColorStop(0.5, '#dc143c');
        carpetGrad.addColorStop(1, '#8b0000');
        ctx.fillStyle = carpetGrad;
        ctx.fillRect(56, 60, 400, 392);
        
        // Gold borders (thicker and more prominent)
        ctx.strokeStyle = '#ffd700';
        ctx.lineWidth = 6;
        ctx.strokeRect(70, 74, 372, 364);
        ctx.lineWidth = 3;
        ctx.strokeRect(82, 86, 348, 340);
        
        // Central medallion (larger)
        ctx.fillStyle = 'rgba(139, 69, 19, 0.7)';
        ctx.beginPath();
        ctx.arc(256, 256, 80, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
        ctx.beginPath();
        ctx.arc(256, 256, 60, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#8b0000';
        ctx.beginPath();
        ctx.arc(256, 256, 40, 0, Math.PI * 2);
        ctx.fill();
        
        // Corner decorations (bigger)
        ctx.fillStyle = 'rgba(255, 215, 0, 0.7)';
        [[130, 134], [382, 134], [130, 378], [382, 378]].forEach(([x, y]) => {
            ctx.beginPath();
            ctx.arc(x, y, 28, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // Secondary corner accent
        ctx.fillStyle = 'rgba(139, 69, 19, 0.5)';
        [[130, 134], [382, 134], [130, 378], [382, 378]].forEach(([x, y]) => {
            ctx.beginPath();
            ctx.arc(x, y, 18, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // Fringe at bottom (more detailed)
        ctx.strokeStyle = '#d2691e';
        ctx.lineWidth = 4;
        ctx.globalAlpha = 0.9;
        for(let x = 76; x < 436; x += 20) {
            ctx.beginPath();
            ctx.moveTo(x, 452);
            ctx.lineTo(x, x % 40 === 0 ? 490 : 485);
            ctx.stroke();
        }
        ctx.globalAlpha = 1;
        
        const iconDataUrl = canvas.toDataURL('image/png');
        
        const manifest = {
            name: "Carpet Expert",
            short_name: "Carpet Expert",
            description: "Field guide for identifying valuable Caucasian carpets",
            start_url: "./",
            display: "standalone",
            background_color: "#1a1a2e",
            theme_color: "#8b4513",
            orientation: "portrait",
            icons: [
                {
                    src: iconDataUrl,
                    sizes: "512x512",
                    type: "image/png",
                    purpose: "any maskable"
                },
                {
                    src: iconDataUrl,
                    sizes: "192x192",
                    type: "image/png"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active', 'bg-gradient-to-r', 'from-carpet-bronze', 'to-carpet-copper'));
            
            document.getElementById(tabName).classList.remove('hidden');
            event.target.classList.add('active', 'bg-gradient-to-r', 'from-carpet-bronze', 'to-carpet-copper');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Search functionality
        let searchResults = [];
        let currentResultIndex = 0;

        function performSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResults');
            const navContainer = document.getElementById('searchResultsNav');
            
            // Clear previous results
            searchResults = [];
            currentResultIndex = 0;
            resultsContainer.innerHTML = '';
            
            if (!term) {
                navContainer.classList.add('hidden');
                return;
            }

            // Search data
            const searchData = getSearchableContent();
            searchResults = searchData.filter(item => 
                item.title.toLowerCase().includes(term) ||
                item.content.toLowerCase().includes(term) ||
                (item.keywords && item.keywords.toLowerCase().includes(term))
            );

            if (searchResults.length > 0) {
                navContainer.classList.remove('hidden');
                updateSearchNav();
                displayCurrentResult();
            } else {
                navContainer.classList.add('hidden');
                resultsContainer.innerHTML = `
                    <div class="bg-red-900 bg-opacity-50 p-4 rounded-lg text-center">
                        <p class="font-bold mb-2">No results found for "${term}"</p>
                        <p class="text-sm opacity-80">Try: dragon, prayer, chiprovtsi, 1850-1920, natural dyes</p>
                    </div>
                `;
            }
        }

        function updateSearchNav() {
            document.getElementById('searchResultCount').textContent = `Found ${searchResults.length} result${searchResults.length !== 1 ? 's' : ''}`;
            document.getElementById('currentResultNum').textContent = `${currentResultIndex + 1} of ${searchResults.length}`;
            
            const currentItem = searchResults[currentResultIndex];
            document.getElementById('currentResultInfo').textContent = `${currentItem.category} ‚Üí ${currentItem.title}`;
        }

        function displayCurrentResult() {
            const resultsContainer = document.getElementById('searchResults');
            const item = searchResults[currentResultIndex];
            
            resultsContainer.innerHTML = `
                <div class="bg-carpet-light p-4 md:p-6 rounded-xl border-4 border-carpet-gold slide-in">
                    <div class="text-carpet-gold text-xs md:text-sm font-bold mb-2">${item.category}</div>
                    <h3 class="text-lg md:text-2xl font-bold text-carpet-gold mb-3">${item.title}</h3>
                    <div class="prose prose-invert max-w-none text-sm md:text-base">${item.content}</div>
                    ${item.value ? `<div class="mt-4 bg-gradient-to-r from-yellow-600 to-yellow-500 text-black px-4 py-2 rounded-lg inline-block font-bold text-sm md:text-base">${item.value}</div>` : ''}
                </div>
            `;
            
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function nextResult() {
            if (currentResultIndex < searchResults.length - 1) {
                currentResultIndex++;
                updateSearchNav();
                displayCurrentResult();
            }
        }

        function previousResult() {
            if (currentResultIndex > 0) {
                currentResultIndex--;
                updateSearchNav();
                displayCurrentResult();
            }
        }

        // Fragment Identification
        function identifyFragment() {
            const region = document.getElementById('region').value;
            const colors = document.getElementById('colors').value;
            const knotDensity = document.getElementById('knotDensity').value;
            const symbols = document.getElementById('symbols').value.toLowerCase();
            const technique = document.getElementById('technique').value;
            
            const resultBox = document.getElementById('resultBox');
            
            if (!region || !colors || !knotDensity || !technique) {
                resultBox.innerHTML = '<p class="text-red-400 font-bold">Please fill in all required fields.</p>';
                resultBox.classList.remove('hidden');
                return;
            }
            
            let confidence = 20; // Start with base confidence
            let valueEstimate = 'Low-Medium ($50-$300)';
            let recommendation = '';
            let details = [];
            
            // REGION-SPECIFIC ANALYSIS
            
            // ===== ARMENIA =====
            if (region === 'armenia') {
                confidence += 10; // Base for selecting Armenia
                
                // Dragon/Vishap - HIGHEST VALUE
                if (symbols.includes('dragon') || symbols.includes('vishap')) {
                    confidence += 40;
                    valueEstimate = 'Very High ($800-$5,000+ per fragment)';
                    recommendation = 'üéØ PRIORITY BUY - Armenian dragon fragments are museum-quality. Even small pieces highly valuable.';
                    details.push('Dragon/vishap detected - Armenian specialty');
                }
                
                // Cross patterns
                if (symbols.includes('cross') || symbols.includes('khachkar')) {
                    confidence += 25;
                    details.push('Cross/khachkar - Armenian Christian indicator');
                    if (!recommendation) valueEstimate = 'High ($300-$2,000)';
                }
                
                // Eagle
                if (symbols.includes('eagle') || symbols.includes('artsiv')) {
                    confidence += 30;
                    valueEstimate = 'Very High ($500-$3,500 per fragment)';
                    recommendation = 'üéØ PRIORITY BUY - Armenian eagle fragments (especially double-headed) very collectible';
                    details.push('Eagle symbol - Armenian national symbol');
                }
                
                // Armenian animals
                if (symbols.includes('peacock') || symbols.includes('nightingale') || symbols.includes('bird')) {
                    confidence += 20;
                    details.push('Bird motifs common in Armenian work');
                    if (!recommendation) valueEstimate = 'Medium-High ($200-$1,500)';
                }
                
                // Roses/florals
                if (symbols.includes('rose') || symbols.includes('flower') || symbols.includes('floral')) {
                    confidence += 15;
                    details.push('Floral motifs - possible Karabakh');
                    if (!recommendation) valueEstimate = 'Medium ($150-$800)';
                }
                
                // Color analysis for Armenia
                if (colors === 'red-blue') {
                    confidence += 15;
                    details.push('Classic Armenian color palette (deep reds + indigo)');
                }
                
                // Knot density for Armenia
                if (knotDensity === 'medium' || knotDensity === 'low') {
                    confidence += 10;
                    details.push('Knot density consistent with Armenian tribal work');
                }
                
                // Pile technique
                if (technique === 'pile') {
                    confidence += 10;
                    details.push('Knotted pile - typical Armenian technique');
                }
            }
            
            // ===== AZERBAIJAN =====
            if (region === 'azerbaijan') {
                confidence += 10;
                
                // Prayer rug - HIGHEST VALUE
                if (symbols.includes('prayer') || symbols.includes('mihrab') || symbols.includes('arch') || symbols.includes('niche')) {
                    confidence += 45;
                    valueEstimate = 'Very High ($600-$4,000+ per fragment)';
                    recommendation = 'üéØ PRIORITY BUY - Prayer rug fragments (especially Shirvan) highly valuable. Even partial mihrab worth buying.';
                    details.push('Prayer niche/mihrab - premium item');
                }
                
                // Lamp/hands motifs
                if (symbols.includes('lamp') || symbols.includes('hand')) {
                    confidence += 20;
                    details.push('Lamp/hands common in prayer rugs');
                }
                
                // High knot density = Kuba/Chi-Chi
                if (knotDensity === 'very-high' || knotDensity === 'high') {
                    confidence += 30;
                    valueEstimate = 'Very High ($500-$3,500 per fragment)';
                    recommendation = 'üéØ PRIORITY BUY - Very fine weaving suggests Kuba or Chi-Chi. Even small fragments worth $500+.';
                    details.push('Fine weaving - possible Kuba/Chi-Chi premium quality');
                }
                
                // Boteh/paisley
                if (symbols.includes('boteh') || symbols.includes('paisley') || symbols.includes('buta')) {
                    confidence += 20;
                    details.push('Boteh pattern - Azerbaijani/Shirvan indicator');
                    if (!recommendation) valueEstimate = 'Medium ($120-$700)';
                }
                
                // Star/geometric
                if (symbols.includes('star') || symbols.includes('geometric') || symbols.includes('medallion')) {
                    confidence += 15;
                    details.push('Geometric patterns typical of Azerbaijani work');
                }
                
                // Color analysis
                if (colors === 'red-blue' || colors === 'black-white') {
                    confidence += 15;
                    details.push('Classic Shirvan/Kuba color palette');
                }
            }
            
            // ===== BULGARIA =====
            if (region === 'bulgaria') {
                confidence += 10;
                
                if (technique === 'kilim') {
                    confidence += 20;
                    details.push('Kilim technique - Bulgaria specialty');
                    
                    // Chiprovtsi indicators
                    if (symbols.includes('rose') || symbols.includes('chiprovtsi') || symbols.includes('flower')) {
                        confidence += 40;
                        valueEstimate = 'Very High ($400-$2,500 per fragment)';
                        recommendation = 'üéØ PRIORITY BUY - Possible Chiprovtsi UNESCO! Even fragments valuable. CRITICAL: Check reversibility.';
                        details.push('Rose motif + kilim = possible Chiprovtsi');
                    }
                    
                    // Natural vibrant colors
                    if (colors === 'vibrant') {
                        confidence += 15;
                        details.push('Vibrant natural dyes typical of Chiprovtsi');
                    }
                }
                
                // Cross patterns (Bulgarian Christian)
                if (symbols.includes('cross')) {
                    confidence += 20;
                    details.push('Cross patterns - Bulgarian Christian tradition');
                }
            }
            
            // ===== GEORGIA =====
            if (region === 'georgia') {
                confidence += 10;
                
                // Cross patterns
                if (symbols.includes('cross')) {
                    confidence += 25;
                    valueEstimate = 'Medium-High ($200-$1,200)';
                    details.push('Christian cross - Georgian specialty');
                }
                
                // Grape vine
                if (symbols.includes('grape') || symbols.includes('vine')) {
                    confidence += 30;
                    valueEstimate = 'High ($250-$1,500)';
                    recommendation = '‚ö° GOOD VALUE - Georgian fragments undervalued. Grape vine = wine culture.';
                    details.push('Grape vine - Georgian wine culture symbol');
                }
                
                // Kilims
                if (technique === 'kilim') {
                    confidence += 15;
                    details.push('Georgian kilim fragments often undervalued');
                }
            }
            
            // ===== ALBANIA =====
            if (region === 'albania') {
                confidence += 10;
                
                if (technique === 'kilim') {
                    confidence += 25;
                    valueEstimate = 'Low-Medium ($30-$400)';
                    recommendation = '‚ö° EMERGING MARKET - Albanian fragments rising value. Buy cheap now, flip for 2-3x in 2-3 years.';
                    details.push('Albanian kilim - emerging market opportunity');
                }
                
                // Pile rugs rare
                if (technique === 'pile') {
                    confidence += 35;
                    valueEstimate = 'High ($300-$2,000 per fragment)';
                    recommendation = 'üéØ RARE FIND - Albanian pile fragments extremely uncommon!';
                    details.push('Albanian pile rug - RARE');
                }
                
                // Geometric
                if (symbols.includes('geometric') || symbols.includes('diamond') || symbols.includes('zigzag')) {
                    confidence += 15;
                    details.push('Geometric patterns typical of Albanian work');
                }
            }
            
            // GENERAL INDICATORS (apply to all regions)
            
            // Inscriptions
            if (symbols.includes('inscription') || symbols.includes('text') || symbols.includes('date') || symbols.includes('letter')) {
                confidence += 35;
                valueEstimate = 'Very High (+200-400% premium on any fragment)';
                recommendation = 'üéØ PHOTOGRAPH IMMEDIATELY - Woven inscriptions multiply value dramatically!';
                details.push('Woven inscriptions - major value multiplier');
            }
            
            // Animals in general
            if (symbols.includes('animal') || symbols.includes('lion') || symbols.includes('deer') || symbols.includes('horse') || symbols.includes('camel')) {
                confidence += 15;
                details.push('Animal motifs increase fragment value');
            }
            
            // Cap confidence at 95%
            confidence = Math.min(confidence, 95);
            
            // Determine verdict
            let verdict = '';
            let verdictColor = '';
            
            if (confidence >= 75) {
                verdict = '‚úÖ HIGH CONFIDENCE - Strong indicators present';
                verdictColor = 'bg-green-700';
            } else if (confidence >= 50) {
                verdict = '‚ö†Ô∏è MODERATE CONFIDENCE - Further investigation recommended';
                verdictColor = 'bg-yellow-700';
            } else if (confidence >= 30) {
                verdict = 'ü§î LOW-MODERATE - Possible but needs authentication';
                verdictColor = 'bg-orange-700';
            } else {
                verdict = '‚ùå INSUFFICIENT DATA - Need more information';
                verdictColor = 'bg-red-700';
            }
            
            resultBox.innerHTML = `
                <h3 class="text-xl md:text-2xl font-bold text-carpet-gold mb-4">Fragment Analysis Results</h3>
                <div class="space-y-3">
                    <div class="bg-carpet-dark p-4 rounded-lg">
                        <div class="text-sm md:text-base mb-1">Confidence Level:</div>
                        <div class="text-xl md:text-3xl font-bold text-carpet-gold">${confidence}%</div>
                    </div>
                    <div class="bg-carpet-dark p-4 rounded-lg">
                        <div class="text-sm md:text-base mb-1">Fragment Value Range:</div>
                        <div class="text-lg md:text-2xl font-bold text-green-400">${valueEstimate}</div>
                        <div class="text-xs md:text-sm opacity-70 mt-1">*For typical fragment sizes (6"x6" to 12"x18")</div>
                    </div>
                    ${recommendation ? `<div class="bg-green-700 bg-opacity-50 p-4 rounded-lg border-2 border-green-500"><div class="font-bold text-base md:text-lg">${recommendation}</div></div>` : ''}
                    <div class="${verdictColor} bg-opacity-70 p-4 rounded-lg border-2 border-current">
                        <div class="font-bold text-sm md:text-base">${verdict}</div>
                    </div>
                    ${details.length > 0 ? `
                    <div class="bg-carpet-dark p-4 rounded-lg">
                        <div class="font-bold mb-2 text-sm md:text-base">Detection Details:</div>
                        <ul class="list-disc list-inside space-y-1 text-xs md:text-sm">
                            ${details.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    <div class="bg-carpet-dark p-4 rounded-lg">
                        <div class="font-bold mb-2 text-sm md:text-base">Fragment Buying Tips:</div>
                        <ul class="list-disc list-inside space-y-1 text-xs md:text-sm">
                            <li>Photograph front AND back - pattern should be visible on reverse</li>
                            <li>Measure actual size (fragments priced by square inch)</li>
                            <li>Count knots in 1" square (KPSI = value indicator)</li>
                            <li>Smell test - chemical = synthetic dyes = walk away</li>
                            <li>Check edges - original selvedge adds value</li>
                            <li>Look for abrash (color banding) = natural dyes = pre-1900</li>
                            <li>Even small dragon/eagle/mihrab fragments worth buying</li>
                        </ul>
                    </div>
                </div>
            `;
            
            resultBox.classList.remove('hidden');
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Symbol filtering
        function filterSymbols(level) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-carpet-bronze');
            });
            event.target.classList.add('active', 'bg-carpet-bronze');
            
            renderSymbols(level);
        }

        function renderSymbols(filter = 'all') {
            const symbols = getSymbolData();
            const filtered = filter === 'all' ? symbols : symbols.filter(s => s.value === filter);
            
            const grid = document.getElementById('symbolsGrid');
            grid.innerHTML = filtered.map(s => `
                <div class="bg-carpet-light p-4 rounded-lg border-l-4 border-carpet-bronze">
                    <div class="text-lg md:text-xl font-bold mb-2">${s.icon} ${s.name}</div>
                    <div class="text-xs md:text-sm mb-2"><strong>Meaning:</strong> ${s.meaning}</div>
                    <div class="text-xs md:text-sm mb-2">${s.info}</div>
                    <div class="bg-gradient-to-r from-yellow-600 to-yellow-500 text-black px-3 py-1 rounded inline-block text-xs md:text-sm font-bold mt-2">
                        ${s.valueLabel}
                    </div>
                </div>
            `).join('');
        }

        // Region details
        function showRegion(region) {
            const detail = document.getElementById('regionDetail');
            const data = getRegionData(region);
            
            let weaveTypesHTML = '';
            if (data.weaveTypes) {
                weaveTypesHTML = `
                    <div class="bg-gradient-to-r from-yellow-900 to-yellow-800 p-4 md:p-6 rounded-xl mt-4 border-2 border-yellow-600">
                        <h4 class="text-lg md:text-xl font-bold text-yellow-200 mb-4">üîç ${data.weaveTypes.title}</h4>
                        ${data.weaveTypes.types.map(type => `
                            <div class="bg-black bg-opacity-40 p-4 rounded-lg mb-4 last:mb-0">
                                <div class="text-base md:text-lg font-bold text-yellow-300 mb-2">${type.name}</div>
                                
                                <div class="mb-3">
                                    <div class="text-xs md:text-sm font-bold text-yellow-200 mb-1">How to Recognize (Touch & Feel):</div>
                                    <div class="text-xs md:text-sm text-gray-200">${type.howToRecognize}</div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="text-xs md:text-sm font-bold text-yellow-200 mb-1">Visual Identification:</div>
                                    <div class="text-xs md:text-sm text-gray-200">${type.visual}</div>
                                </div>
                                
                                ${type.knotType ? `
                                <div class="mb-3">
                                    <div class="text-xs md:text-sm font-bold text-yellow-200 mb-1">Knot Type:</div>
                                    <div class="text-xs md:text-sm text-gray-200">${type.knotType}</div>
                                </div>
                                ` : ''}
                                
                                ${type.testTip ? `
                                <div class="mb-3">
                                    <div class="text-xs md:text-sm font-bold text-green-300 mb-1">üí° Field Test:</div>
                                    <div class="text-xs md:text-sm text-gray-200">${type.testTip}</div>
                                </div>
                                ` : ''}
                                
                                ${type.authentication ? `
                                <div class="bg-red-900 bg-opacity-40 p-3 rounded border border-red-500">
                                    <div class="text-xs md:text-sm font-bold text-red-300 mb-1">‚ö†Ô∏è Authentication Key:</div>
                                    <div class="text-xs md:text-sm text-gray-200">${type.authentication}</div>
                                </div>
                                ` : ''}
                                
                                ${type.common ? `
                                <div class="text-xs md:text-sm text-gray-400 italic mt-2">${type.common}</div>
                                ` : ''}
                                
                                ${type.rarity ? `
                                <div class="bg-yellow-600 bg-opacity-30 p-2 rounded mt-2 text-xs md:text-sm font-bold text-yellow-200">${type.rarity}</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            detail.innerHTML = `
                <h3 class="text-xl md:text-2xl font-bold text-carpet-gold mb-4">${data.name}</h3>
                <div class="space-y-4 text-sm md:text-base">
                    <div><strong>Peak Period:</strong> ${data.period}</div>
                    <div><strong>Key Types:</strong> ${data.types}</div>
                    <div><strong>Fragment Value Range:</strong> ${data.value}</div>
                    <div class="bg-carpet-dark p-4 rounded-lg">
                        <div class="font-bold mb-2">What to Look For:</div>
                        <ul class="list-disc list-inside space-y-1">
                            ${data.lookFor.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    ${weaveTypesHTML}
                    ${data.tip ? `<div class="bg-green-700 bg-opacity-30 p-4 rounded-lg border-2 border-green-500"><strong>üí° Expert Field Tip:</strong> ${data.tip}</div>` : ''}
                </div>
            `;
            
            detail.classList.remove('hidden');
            detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Authentication tools
        function showAuthTool(tool) {
            const content = document.getElementById('authToolContent');
            
            if (tool === 'checklist') {
                content.innerHTML = `
                    <div class="bg-carpet-dark p-4 md:p-6 rounded-xl mt-4">
                        <h3 class="text-lg md:text-xl font-bold mb-4">Authentication Checklist</h3>
                        <div class="space-y-3">
                            <label class="flex items-start gap-3 bg-carpet-light p-3 rounded-lg cursor-pointer hover:bg-opacity-80">
                                <input type="checkbox" class="mt-1" data-points="10">
                                <span class="text-sm md:text-base">Musty, earthy wool smell (not chemical)</span>
                            </label>
                            <label class="flex items-start gap-3 bg-carpet-light p-3 rounded-lg cursor-pointer hover:bg-opacity-80">
                                <input type="checkbox" class="mt-1" data-points="15">
                                <span class="text-sm md:text-base">Horizontal color banding (abrash) visible</span>
                            </label>
                            <label class="flex items-start gap-3 bg-carpet-light p-3 rounded-lg cursor-pointer hover:bg-opacity-80">
                                <input type="checkbox" class="mt-1" data-points="15">
                                <span class="text-sm md:text-base">Pattern clearly visible on reverse side</span>
                            </label>
                            <label class="flex items-start gap-3 bg-carpet-light p-3 rounded-lg cursor-pointer hover:bg-opacity-80">
                                <input type="checkbox" class="mt-1" data-points="20">
                                <span class="text-sm md:text-base">Irregular knot sizes (hand-tied)</span>
                            </label>
                            <label class="flex items-start gap-3 bg-carpet-light p-3 rounded-lg cursor-pointer hover:bg-opacity-80">
                                <input type="checkbox" class="mt-1" data-points="25">
                                <span class="text-sm md:text-base">Wool warp and weft (pre-1900)</span>
                            </label>
                            <label class="flex items-start gap-3 bg-red-900 bg-opacity-50 p-3 rounded-lg cursor-pointer hover:bg-opacity-60">
                                <input type="checkbox" class="mt-1" data-points="-30">
                                <span class="text-sm md:text-base">‚ùå Bright neon colors (synthetic dyes)</span>
                            </label>
                            <label class="flex items-start gap-3 bg-red-900 bg-opacity-50 p-3 rounded-lg cursor-pointer hover:bg-opacity-60">
                                <input type="checkbox" class="mt-1" data-points="-25">
                                <span class="text-sm md:text-base">‚ùå Perfectly uniform knots (machine-made)</span>
                            </label>
                        </div>
                        <button onclick="calculateAuth()" class="w-full mt-4 bg-gradient-to-r from-carpet-bronze to-carpet-copper text-white py-3 md:py-4 rounded-lg font-bold text-sm md:text-base">
                            Calculate Score
                        </button>
                        <div id="authScore" class="mt-4"></div>
                    </div>
                `;
            } else if (tool === 'age') {
                content.innerHTML = `
                    <div class="bg-carpet-dark p-4 md:p-6 rounded-xl mt-4">
                        <h3 class="text-lg md:text-xl font-bold mb-4">Age Estimation</h3>
                        <div class="space-y-4 text-sm md:text-base">
                            <div class="bg-carpet-light p-4 rounded-lg">
                                <div class="font-bold mb-2">üé® By Dye Technology:</div>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Pre-1860: ALL natural dyes</li>
                                    <li>1860-1900: Mix natural + synthetic</li>
                                    <li>1900-1920: Predominantly synthetic</li>
                                    <li>Post-1920: All synthetic (low value)</li>
                                    <li>Post-1980: Natural dye revival (reproductions!)</li>
                                </ul>
                            </div>
                            <div class="bg-carpet-light p-4 rounded-lg">
                                <div class="font-bold mb-2">üßµ By Foundation:</div>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Wool warp + weft = Pre-1900</li>
                                    <li>Cotton warp, wool weft = 1900-1930</li>
                                    <li>Cotton warp + weft = Post-1960</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tool === 'redflags') {
                content.innerHTML = `
                    <div class="bg-carpet-dark p-4 md:p-6 rounded-xl mt-4">
                        <h3 class="text-lg md:text-xl font-bold mb-4 text-red-400">üö´ Red Flags - Walk Away</h3>
                        <div class="space-y-2 text-sm md:text-base">
                            <div class="bg-red-900 bg-opacity-50 p-3 rounded-lg">‚ùå Chemical smell when sniffing</div>
                            <div class="bg-red-900 bg-opacity-50 p-3 rounded-lg">‚ùå Neon colors (orange, purple, lime)</div>
                            <div class="bg-red-900 bg-opacity-50 p-3 rounded-lg">‚ùå Machine-perfect knots</div>
                            <div class="bg-red-900 bg-opacity-50 p-3 rounded-lg">‚ùå New fringe on worn pile</div>
                            <div class="bg-red-900 bg-opacity-50 p-3 rounded-lg">‚ùå Pakistan/Afghanistan label</div>
                            <div class="bg-red-900 bg-opacity-50 p-3 rounded-lg">‚ùå Too perfect for claimed age</div>
                            <div class="bg-red-900 bg-opacity-50 p-3 rounded-lg">‚ùå Price suspiciously low</div>
                        </div>
                    </div>
                `;
            }
        }

        function calculateAuth() {
            const checkboxes = document.querySelectorAll('#authToolContent input[type="checkbox"]:checked');
            let score = 0;
            checkboxes.forEach(cb => score += parseInt(cb.getAttribute('data-points')));
            
            const normalized = Math.max(0, Math.min(100, ((score + 50) / 135) * 100));
            const scoreDiv = document.getElementById('authScore');
            
            let verdict = '';
            let color = '';
            
            if (normalized >= 75) {
                verdict = '‚úÖ STRONG AUTHENTICATION - Proceed with confidence';
                color = 'bg-green-700';
            } else if (normalized >= 50) {
                verdict = '‚ö†Ô∏è MODERATE - Investigate further before buying';
                color = 'bg-yellow-700';
            } else {
                verdict = '‚ùå LOW CONFIDENCE - Walk away';
                color = 'bg-red-700';
            }
            
            scoreDiv.innerHTML = `
                <div class="${color} bg-opacity-70 p-4 rounded-lg border-2 border-current">
                    <div class="text-2xl md:text-4xl font-bold mb-2">${normalized.toFixed(0)}%</div>
                    <div class="font-bold text-sm md:text-base">${verdict}</div>
                </div>
            `;
        }

        // Data functions
        function getSearchableContent() {
            return [
                {
                    category: "Armenia",
                    title: "Armenian Dragon (Vishap)",
                    content: "S-curved dragon motifs are distinctly Armenian, especially in Karabakh pieces. Look for hooked tongues and scale patterns. These are museum-quality finds. Paired combat dragons indicate pre-1850 work.",
                    value: "$8,000-$80,000+",
                    keywords: "dragon vishap armenia karabakh s-curve scales high-value combat pre-1850"
                },
                {
                    category: "Azerbaijan",
                    title: "Shirvan Prayer Rugs",
                    content: "Prayer rugs (namazlyk) with distinctive mihrab arch. Tightly woven (100-180 KPSI) with dark blue or black fields. Often feature lamp or hands motifs.",
                    value: "$5,000-$40,000",
                    keywords: "shirvan prayer mihrab azerbaijani niche arch high-value namazlyk lamp hands"
                },
                {
                    category: "Bulgaria",
                    title: "Chiprovtsi Reversible Kilims",
                    content: "UNESCO heritage textiles. CRITICAL TEST: Pattern must be identical on both sides. Diagonal ribbing on surface from oblique weaving. Natural dyes only.",
                    value: "$2,000-$40,000",
                    keywords: "chiprovtsi bulgaria reversible unesco kilim rose very-high-value diagonal ribs"
                },
                {
                    category: "Azerbaijan",
                    title: "Kuba Fine Weaving",
                    content: "Finest weaving in Caucasus at 150-250 KPSI. Chi-Chi subtype with diagonal lattice is premium. Museum-quality pieces.",
                    value: "$10,000-$60,000",
                    keywords: "kuba chi-chi azerbaijan fine-weave very-high-knot museum lattice"
                },
                {
                    category: "Armenia",
                    title: "Karabakh Carpets",
                    content: "Large-scale floral motifs, especially roses and nightingales. Deep indigo backgrounds with rich reds. Famous for Eagle Kazak and Cloudband designs.",
                    value: "$15,000-$80,000+",
                    keywords: "karabakh armenia eagle kazak cloudband roses nightingale high-value indigo"
                },
                {
                    category: "Dating",
                    title: "Pre-1900 Indicators",
                    content: "Wool warp AND weft threads, natural dyes only (madder, indigo, walnut), irregular knots, abrash color banding. Chemical smell = walk away.",
                    value: "Authentication Key",
                    keywords: "pre-1900 19th-century natural-dyes wool authentication dating abrash madder indigo"
                },
                {
                    category: "Albania",
                    title: "Albanian Kilims",
                    content: "Flat-weave with bold geometric designs. Traditionally made for dowries. Currently undervalued - emerging market opportunity.",
                    value: "$300-$10,000",
                    keywords: "albania kilim flat-weave emerging undervalued geometric dowry"
                },
                {
                    category: "Symbols",
                    title: "Boteh (Paisley)",
                    content: "Teardrop flame motif from Zoroastrianism. Rows of boteh indicate Azerbaijani origin, particularly Shirvan or Baku region.",
                    value: "Medium Value",
                    keywords: "boteh buta paisley azerbaijan shirvan flame zoroastrian baku"
                },
                {
                    category: "Symbols - Birds",
                    title: "Eagle (Artsiv) - Armenian National Symbol",
                    content: "Double-headed eagle represents Armenian royalty and national identity. Single eagle = power and protection. 'Eagle Kazak' carpets are highly valuable. Look for spread wings or perched forms with detailed feather work.",
                    value: "$8,000-$50,000+",
                    keywords: "eagle artsiv bird armenian double-headed national kazak wings feathers royalty power"
                },
                {
                    category: "Symbols - Birds",
                    title: "Peacock (Taous) - Immortality Symbol",
                    content: "Peacock with spread tail represents immortality and paradise. Armenian Christian symbol of resurrection. Also sacred in Yezidi religion. Look for distinctive eye patterns in tail feathers. High value indicator.",
                    value: "$5,000-$40,000",
                    keywords: "peacock taous bird armenian yezidi immortality paradise resurrection tail eyes feathers"
                },
                {
                    category: "Symbols - Birds",
                    title: "Nightingale (Sokhak) - Love & Romance",
                    content: "Small bird paired with roses in Karabakh carpets. Symbol of pure love and soul's yearning. Common in Armenian poetry. Often in garden scenes with flowering branches.",
                    value: "$10,000-$60,000",
                    keywords: "nightingale sokhak bird armenian karabakh rose love romance garden poetry soul"
                },
                {
                    category: "Symbols - Birds",
                    title: "Rooster (Horoz) - Vigilance & Protection",
                    content: "Common in village carpets. Rooster wards off evil spirits at dawn. Symbol of vigilance and reproductive fertility. Often depicted with elaborate tail feathers.",
                    value: "$2,000-$15,000",
                    keywords: "rooster horoz bird cock chicken village protection evil dawn fertility tail"
                },
                {
                    category: "Symbols - Birds",
                    title: "Dove (Aghavni) - Holy Spirit & Peace",
                    content: "Christian symbol of Holy Spirit and peace. Often holds olive branch. Paired doves = marital harmony. Around cross motifs = Trinity representation.",
                    value: "$5,000-$30,000",
                    keywords: "dove aghavni bird armenian christian holy-spirit peace olive-branch harmony trinity"
                },
                {
                    category: "Symbols - Birds",
                    title: "Falcon/Hawk - Noble Hunting Bird",
                    content: "Symbol of nobility, hunting prowess, and keen sight. Royal hunt scenes. Swift justice representation. Sharp vision = wisdom.",
                    value: "$3,000-$20,000",
                    keywords: "falcon hawk bird hunting noble vision wisdom royal swift predator"
                },
                {
                    category: "Symbols - Birds",
                    title: "Owl - Wisdom & Mystery",
                    content: "Nocturnal knowledge symbol. Athena's bird. Night guardian. Sometimes ill omen in folklore. Rare but meaningful when present.",
                    value: "$2,000-$12,000",
                    keywords: "owl bird wisdom night nocturnal athena mystery knowledge guardian"
                },
                {
                    category: "Symbols - Birds",
                    title: "Swan - Grace & Fidelity",
                    content: "Paired swans represent eternal love and fidelity. White = purity. Transformation symbol. Lake and pond scenes. Armenian and Persian carpets.",
                    value: "$4,000-$25,000",
                    keywords: "swan bird grace purity love fidelity transformation lake white armenian persian"
                },
                {
                    category: "Symbols - Birds",
                    title: "Duck - Adaptation & Harmony",
                    content: "Three element symbolism (water-earth-air). Domestic bird. Paired ducks = marital harmony. Water birds in general.",
                    value: "$2,000-$10,000",
                    keywords: "duck bird water adaptation harmony domestic paired elements"
                },
                {
                    category: "Symbols - Birds",
                    title: "Parrot - Exotic Trade & Speech",
                    content: "Indicates trade connections and exotic luxury. Speech and prophecy symbol. Bright colors = joy. Persian-influenced carpets.",
                    value: "$3,000-$18,000",
                    keywords: "parrot bird exotic trade speech colorful persian luxury prophecy"
                },
                {
                    category: "Symbols - Animals",
                    title: "Lion (Lev/Arslan) - Royal Power",
                    content: "Symbol of royal power, courage, and sun. Persian influence. Lion-sun motif common. Paired with lamb = peace. Fighting stance = valor.",
                    value: "$5,000-$35,000",
                    keywords: "lion lev arslan animal persian royal courage sun lamb valor power"
                },
                {
                    category: "Symbols - Animals",
                    title: "Deer/Stag (Eljen) - Grace & Spirituality",
                    content: "Antlered stag = masculine power. Doe = feminine grace. Paired = harmony. Common in hunting scenes. Spiritual aspiration symbol.",
                    value: "$4,000-$25,000",
                    keywords: "deer stag eljen animal antlers hunting grace spiritual harmony doe"
                },
                {
                    category: "Symbols - Animals",
                    title: "Horse (Dzi) - Nobility & Freedom",
                    content: "Rider indicates nobility. Rearing horse = power. Pastoral scenes common. Tribal prestige symbol. Warrior status.",
                    value: "$3,000-$20,000",
                    keywords: "horse dzi animal nobility freedom warrior rider pastoral tribal power"
                },
                {
                    category: "Symbols - Animals",
                    title: "Camel - Trade & Endurance",
                    content: "Silk Road symbol. Merchant wealth indicator. Single hump (dromedary) vs two-hump (Bactrian). Caravan scenes. Desert endurance.",
                    value: "$2,000-$15,000",
                    keywords: "camel animal trade silk-road merchant caravan desert endurance dromedary bactrian"
                },
                {
                    category: "Symbols - Animals",
                    title: "Ram - Fertility & Sacrifice",
                    content: "Ram's horn (Ko√ß Boynuzu) = S-curve spiral at corners. Male power, fertility, sacrifice (Ibrahim/Abraham). Aries zodiac. Tribal strength.",
                    value: "$3,000-$18,000",
                    keywords: "ram sheep horn animal spiral fertility sacrifice ibrahim abraham zodiac tribal"
                },
                {
                    category: "Symbols - Animals",
                    title: "Dog - Loyalty & Protection",
                    content: "Rare in main field. Running Dog border pattern common. Guardian of flocks and home. Shepherd companion. Fidelity symbol.",
                    value: "$2,000-$12,000",
                    keywords: "dog animal loyalty protection guardian shepherd fidelity running-dog border"
                },
                {
                    category: "Symbols - Animals",
                    title: "Goat - Mountain Resilience",
                    content: "Mountain goat in Caucasus. Sure-footed = overcoming obstacles. Horns = virility. Independence and climbing.",
                    value: "$2,000-$10,000",
                    keywords: "goat animal mountain caucasus resilience horns obstacles independence climbing"
                },
                {
                    category: "Symbols - Animals",
                    title: "Bear (Arj) - Armenian National Animal",
                    content: "Bear = Arj in Armenian, related to Armenia name. Symbol of strength and courage. Protective power. Rare but significant when present.",
                    value: "$5,000-$30,000",
                    keywords: "bear arj animal armenian national strength courage protection rare"
                },
                {
                    category: "Symbols - Animals",
                    title: "Fox - Cunning & Wisdom",
                    content: "Folklore trickster symbol. Clever survivor. Adaptation. Less common than other animals. Reynard tales influence.",
                    value: "$2,000-$12,000",
                    keywords: "fox animal cunning wisdom trickster folklore adaptation clever survivor"
                },
                {
                    category: "Symbols - Animals",
                    title: "Fish (Dzuk) - Abundance & Christianity",
                    content: "Paired fish = fertility. Christian ichthys symbol. Water and life connection. Armenian church symbolism. Abundance.",
                    value: "$3,000-$18,000",
                    keywords: "fish dzuk animal water christian fertility abundance ichthys armenian church"
                },
                {
                    category: "Symbols - Animals",
                    title: "Scorpion (Karich) - Protection",
                    content: "Apotropaic symbol - protects by threatening evil. Zodiac sign. Desert regions. Prominent tail sting. Danger and survival.",
                    value: "$2,000-$10,000",
                    keywords: "scorpion karich animal protection zodiac desert danger tail sting apotropaic"
                },
                {
                    category: "Symbols - Animals",
                    title: "Butterfly (Titer) - Soul & Resurrection",
                    content: "Christian resurrection symbol. Paired with flowers. Symmetrical wing patterns. Transformation. Life cycle = human mortality.",
                    value: "$3,000-$15,000",
                    keywords: "butterfly titer animal insect soul resurrection transformation christian mortality wings"
                },
                {
                    category: "Symbols - Animals",
                    title: "Bee (Meghu) - Industry & Community",
                    content: "Hive = organized society. Honey = prosperity. Worker ethic. Divine organization. Rare but meaningful.",
                    value: "$3,000-$15,000",
                    keywords: "bee meghu animal insect industry community hive honey prosperity organization"
                },
                {
                    category: "Symbols - Animals",
                    title: "Spider (Sard) - Weaving & Fate",
                    content: "Master weaver (carpet metaphor!). Web of fate. Patience creates beauty. Feminine creation power. Philosophical symbol.",
                    value: "$2,000-$12,000",
                    keywords: "spider sard animal insect weaving fate web patience creation philosophical"
                },
                {
                    category: "Symbols - Flowers",
                    title: "Rose (Vard) - Armenian Love Symbol",
                    content: "Red rose = passion. White = purity. Karabakh famous for rose carpets. 'Gul' means rose. Persian garden tradition. Central to Armenian identity.",
                    value: "$8,000-$50,000",
                    keywords: "rose vard flower armenian karabakh love passion purity gul garden persian"
                },
                {
                    category: "Symbols - Flowers",
                    title: "Pomegranate (Nur) - Fertility Symbol",
                    content: "Many seeds = fertility. Unity in diversity. Armenian national symbol. Paradise fruit. Often shown opened revealing seeds.",
                    value: "$5,000-$35,000",
                    keywords: "pomegranate nur fruit armenian fertility seeds unity paradise national-symbol"
                },
                {
                    category: "Symbols - Flowers",
                    title: "Grape Vine (Khaghagh) - Georgian Wine Culture",
                    content: "Georgian signature motif (ancient wine culture). Christian eucharist. Leaves and grape clusters. Harvest bounty and abundance.",
                    value: "$4,000-$25,000",
                    keywords: "grape vine khaghagh georgian wine christian eucharist harvest abundance leaves clusters"
                },
                {
                    category: "Symbols - Flowers",
                    title: "Tulip (Lale) - Ottoman Luxury",
                    content: "Ottoman signature flower from 'Tulip Era' Turkey. Simple 3-petal form. Perfect love symbol. Persian origin. Paradise garden flower.",
                    value: "$3,000-$18,000",
                    keywords: "tulip lale flower ottoman turkish persian love paradise garden three-petal"
                },
                {
                    category: "Symbols - Flowers",
                    title: "Lotus - Purity & Enlightenment",
                    content: "Buddhist/Hindu symbol via Silk Road. Sacred flower. Rises pure from muddy water = spiritual transcendence and rebirth.",
                    value: "$4,000-$22,000",
                    keywords: "lotus flower buddhist hindu silk-road purity enlightenment rebirth transcendence sacred"
                },
                {
                    category: "Symbols - Flowers",
                    title: "Carnation (Mekhak) - Divine Love",
                    content: "Christian passion flower. Ruffled petals distinctive. Pink and red common colors. Mother's love. Ottoman favorite.",
                    value: "$2,000-$12,000",
                    keywords: "carnation mekhak flower christian passion love mother ottoman ruffled petals"
                },
                {
                    category: "Symbols - Flowers",
                    title: "Cypress Tree (Sarv) - Eternity",
                    content: "Evergreen = eternal life. Cemetery tree = death/mourning. Flame-like shape. Persian gardens. Zoroastrian sacred tree.",
                    value: "$3,000-$18,000",
                    keywords: "cypress sarv tree evergreen eternity death mourning persian zoroastrian sacred flame"
                }
            ];
        }

        function getSymbolData() {
            return [
                // VERY HIGH VALUE SYMBOLS
                { icon: "üêâ", name: "Dragon (Vishap/Ejder)", meaning: "Power, protection, water source guardian", info: "S-curved Armenian dragons are museum-quality. Look for paired combat dragons, scale patterns, hooked tongues. Karabakh specialty. Pre-1850 indicator.", value: "very-high", valueLabel: "VERY HIGH VALUE", regions: "Armenian, Azerbaijani" },
                { icon: "üïå", name: "Prayer Niche (Mihrab)", meaning: "Direction to Mecca, portal to divine", info: "Prayer rugs always premium. Look for pointed arch, lamp above (kandil), hands below. Shirvan, Kuba masters.", value: "very-high", valueLabel: "VERY HIGH VALUE", regions: "Azerbaijani, Turkish" },
                { icon: "ü¶Ö", name: "Eagle (Artsiv)", meaning: "Divine messenger, Armenian national symbol, freedom", info: "Double-headed eagle = Armenian royalty. Single eagle = power, protection. 'Eagle Kazak' carpets highly valuable. Spread wings or perched.", value: "very-high", valueLabel: "VERY HIGH VALUE", regions: "Armenian, Caucasian" },
                { icon: "üåπ", name: "Chiprovtsi Rose", meaning: "Beauty, Bulgarian heritage, UNESCO symbol", info: "Unique to Chiprovtsi kilims. Stylized 8-petaled flower, diagonal stems. REVERSIBILITY TEST CRITICAL.", value: "very-high", valueLabel: "VERY HIGH VALUE", regions: "Bulgarian" },
                { icon: "üêç", name: "Serpent/Water Dragon", meaning: "Water guardian, wisdom, transformation, fertility", info: "Sinuous S-curves, often paired in combat. Armenian specialty. Different from Chinese dragons - more abstract, geometric.", value: "very-high", valueLabel: "VERY HIGH VALUE", regions: "Armenian, Caucasian" },
                
                // HIGH VALUE SYMBOLS
                { icon: "‚úùÔ∏è", name: "Cross Patterns (Khach/Khachkar)", meaning: "Christian faith, four cardinal directions, sacred center", info: "Armenian crosses have elaborate floral terminals. Georgian Bolnisi cross = unique stepped form. Indicates Christian weaver = Armenian/Georgian origin.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Georgian, Bulgarian" },
                { icon: "ü¶ö", name: "Peacock (Taous)", meaning: "Immortality, paradise, Yezidi sacred symbol", info: "Spread tail = full glory. Armenian Christian symbol of resurrection. Also Yezidi religious significance. Look for eye patterns in tail.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Kurdish" },
                { icon: "üê¶", name: "Nightingale (Sokhak)", meaning: "Love, spring, soul's yearning, romance", info: "Small bird paired with roses in Karabakh carpets. Symbol of pure love. Often in garden scenes. Armenian poetry symbol.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Persian" },
                { icon: "üêì", name: "Rooster (Horoz)", meaning: "Vigilance, dawn, protection from evil", info: "Common in village carpets. Wards off evil spirits. Reproductive fertility symbol. Often with elaborate tail feathers.", value: "high", valueLabel: "HIGH VALUE", regions: "Caucasian, Turkish" },
                { icon: "ü¶å", name: "Deer/Stag (‘µ’≤’ª’•÷Ä’∏÷Ç/Eljen)", meaning: "Grace, gentleness, spiritual aspiration", info: "Antlered stag = masculine power. Doe = feminine grace. Paired = harmony. Common in hunting scenes.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Persian" },
                { icon: "ü¶Å", name: "Lion (Lev/Arslan)", meaning: "Royal power, courage, sun symbol", info: "Persian influence. Lion-sun motif common. Paired with lamb = peace. Fighting stance = valor.", value: "high", valueLabel: "HIGH VALUE", regions: "Persian, Caucasian" },
                { icon: "üå≥", name: "Tree of Life (Hayat Aƒüacƒ±)", meaning: "Immortality, connection earth-heaven, cosmic axis", info: "Cypress (narrow) = death/mourning. Pomegranate tree = fertility. Plane tree = wisdom. Birds in branches add value.", value: "high", valueLabel: "HIGH VALUE", regions: "All regions" },
                { icon: "üåô", name: "Cloudband (Chi)", meaning: "Buddhist cloud, good fortune, Chinese origin", info: "Chi-shaped curves in borders. Pre-1850 Karabakh indicator. Shows Silk Road trade influence. Paired with dragons.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Azerbaijani" },
                { icon: "üí†", name: "Memling Gul", meaning: "Medieval Christian symbol from paintings", info: "Octagonal medallion with cruciform center. Named after 15th c. painter. Indicates quality Shirvan/Kuba work.", value: "high", valueLabel: "HIGH VALUE", regions: "Azerbaijani" },
                { icon: "üåø", name: "Palmette (Shah Abbas)", meaning: "Lotus flower, rebirth, Persian luxury", info: "Multi-lobed floral form. Persian influence indicator. In borders or field. Safavid dynasty symbol.", value: "high", valueLabel: "HIGH VALUE", regions: "Persian-influenced Caucasian" },
                { icon: "üè∫", name: "Elibelinde (Hands on Hips)", meaning: "Mother goddess, fertility, female power, protection", info: "Diamond with protruding triangular 'arms'. Ancient Anatolian fertility goddess. Common in tribal work.", value: "high", valueLabel: "HIGH VALUE", regions: "Turkish, Caucasian" },
                { icon: "ü¶ã", name: "Butterfly (‘π’´’©’•’º/Titer)", meaning: "Soul, transformation, resurrection, spring", info: "Christian resurrection symbol. Paired with flowers. Symmetrical wing patterns. Short lifecycle = human mortality.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Persian" },
                { icon: "üïäÔ∏è", name: "Dove (‘±’≤’°’æ’∂’´/Aghavni)", meaning: "Holy Spirit, peace, purity, messenger", info: "Christian symbol. Often holds olive branch. Paired = marital harmony. Around cross = Trinity.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Georgian" },
                { icon: "üêé", name: "Horse (’Å’´/Dzi)", meaning: "Nobility, freedom, warrior status, speed", info: "Rider indicates nobility. Rearing = power. Pastoral scenes common. Tribal prestige symbol.", value: "high", valueLabel: "HIGH VALUE", regions: "Caucasian, Turkish" },
                { icon: "üê™", name: "Camel (’à÷Ç’≤’ø/Ught)", meaning: "Endurance, desert journey, trade, wealth", info: "Silk Road symbol. Merchant wealth. Single hump (dromedary) vs two-hump (Bactrian). Caravan scenes.", value: "high", valueLabel: "HIGH VALUE", regions: "Azerbaijani, Turkmen" },
                
                // MEDIUM-HIGH VALUE SYMBOLS
                { icon: "üî∑", name: "Boteh (Buta/Paisley)", meaning: "Zoroastrian flame, cypress, life force", info: "Teardrop/flame shape. Rows indicate Azerbaijani (Shirvan/Baku). Single = Persian. Fire worship symbol.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Azerbaijani, Persian" },
                { icon: "‚≠ê", name: "Eight-Pointed Star (G√∂l)", meaning: "Celestial guidance, pre-Islamic sun, infinity", info: "Caucasian stars more angular than Persian. Eight points = cosmic order. Turkmen tribal guls.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian, Turkmen" },
                { icon: "‚ú°Ô∏è", name: "Six-Pointed Star (Solomon's Seal)", meaning: "Divine protection, harmony opposites, Jewish/Muslim", info: "Two overlapping triangles. ‚ñ≤ (fire/male) + ‚ñº (water/female) = balance. Apotropaic (evil protection).", value: "medium", valueLabel: "MEDIUM VALUE", regions: "All regions" },
                { icon: "üåü", name: "Five-Pointed Star", meaning: "Human form, five senses, Islamic symbol", info: "Arms-legs-head representation. Five pillars of Islam. Less common than 8-point in Caucasian work.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Islamic regions" },
                { icon: "üêè", name: "Ram's Horn (Ko√ß Boynuzu)", meaning: "Male power, fertility, sacrifice, protection", info: "S-curve spiral at medallion corners. Aries zodiac. Sacrifice symbol (Ibrahim/Abraham). Tribal strength.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian, Turkish" },
                { icon: "üê∫", name: "Running Dog Border (Kurt ƒ∞zi)", meaning: "Protection, loyalty, guardian spirit, path", info: "Reciprocal Z-pattern creating chain. 'Dog's track'. Common Shirvan border. Continuous protection line.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Azerbaijani" },
                { icon: "üêï", name: "Dog (’á’∏÷Ç’∂/Shun)", meaning: "Loyalty, protection, fidelity, shepherd companion", info: "Rare in main field. More common in border as 'running dog'. Guardian of flocks and home.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian" },
                { icon: "üêë", name: "Sheep (’à’π’≠’°÷Ä/Vochkhar)", meaning: "Wealth, pastoral life, sacrifice, abundance", info: "Flock = wealth indicator. Shepherd scenes. Wool source symbol. Rural life depiction.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian, Anatolian" },
                { icon: "üêê", name: "Goat (‘±’µ’Æ/Ayts)", meaning: "Mountain resilience, independence, climbing", info: "Mountain goat in Caucasus. Sure-footed = overcoming obstacles. Horns = virility.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian, Kurdish" },
                { icon: "ü¶ä", name: "Fox (‘±’≤’∏÷Ç’•’Ω/Aghves)", meaning: "Cunning, wisdom, adaptation, trickster", info: "Folklore symbol. Clever survivor. Less common than other animals. Reynard tales influence.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian" },
                { icon: "üêª", name: "Bear (‘±÷Ä’ª/Arj)", meaning: "Strength, courage, Armenia itself (Arj=bear)", info: "Armenian national animal. Protective power. Rare in carpets but significant when present.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Armenian" },
                { icon: "üêù", name: "Bee (’Ñ’•’≤’∏÷Ç/Meghu)", meaning: "Industry, community, divine organization, sweetness", info: "Hive = organized society. Honey = prosperity. Worker ethic. Rare but meaningful.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Armenian, Georgian" },
                { icon: "ü¶Ç", name: "Scorpion (‘ø’°÷Ä’´’≥/Karich)", meaning: "Protection, danger, desert survival, zodiac", info: "Apotropaic - protects by threatening evil. Zodiac sign. Desert regions. Tail sting prominent.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian, Turkmen" },
                { icon: "üê¢", name: "Turtle/Tortoise", meaning: "Longevity, stability, wisdom, cosmic support", info: "World-bearer in some cosmologies. Slow wisdom. Rare symbol. Protective shell.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian, Central Asian" },
                { icon: "üê†", name: "Fish (’Å’∏÷Ç’Ø/Dzuk)", meaning: "Abundance, fertility, water, Christian symbol", info: "Paired fish = fertility. Christian ichthys symbol. Water/life connection. Armenian church symbolism.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Armenian, Christian" },
                { icon: "ü¶Ö", name: "Falcon/Hawk (‘≤’°’¶’•/Baze)", meaning: "Hunting, nobility, keen sight, speed", info: "Noble hunting bird. Sharp vision = wisdom. Royal hunt symbol. Swift justice.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian, Caucasian" },
                { icon: "ü¶â", name: "Owl (‘≤’∏÷Ç/Bu)", meaning: "Wisdom, night vision, mystery, death", info: "Nocturnal knowledge. Sometimes ill omen. Athena's bird. Night guardian.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Armenian" },
                { icon: "ü¶¢", name: "Swan (‘ø’°÷Ä’°’∫/Karap)", meaning: "Grace, purity, transformation, fidelity", info: "Paired swans = eternal love. White = purity. Transformation (ugly duckling). Lake scenes.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Armenian, Persian" },
                { icon: "ü¶Ü", name: "Duck (‘≤’°’§/Bad)", meaning: "Adaptation, water-earth-air, resourceful", info: "Three element symbolism. Domestic bird. Paired = marital harmony. Water birds general.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian" },
                { icon: "üêì", name: "Hen (’Ä’°’æ/Hav)", meaning: "Motherhood, nurturing, fertility, domestic", info: "With chicks = motherhood. Egg-layer = fertility. Domestic abundance. Rural life.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Village carpets" },
                { icon: "ü™ø", name: "Goose (’ç’°’£/Sag)", meaning: "Vigilance, migration, seasonal change, fidelity", info: "Watchful guardian. Migration = seasons. Mate for life = fidelity. Honking = alarm.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian" },
                { icon: "ü¶ú", name: "Parrot (‘±’≤’°’≤’°’Ø/Aghaghak)", meaning: "Speech, imitation, exotic, colorful", info: "Trade connections. Exotic luxury. Speech/prophecy. Bright colors = joy.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian-influenced" },
                { icon: "üï∑Ô∏è", name: "Spider (’ç’°÷Ä’§/Sard)", meaning: "Weaving, fate, creation, patience", info: "Master weaver (carpet metaphor!). Web of fate. Patience creates beauty. Feminine creation.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Philosophical symbol" },
                
                // FLORAL & PLANT SYMBOLS
                { icon: "üåπ", name: "Rose (’é’°÷Ä’§/Vard)", meaning: "Love, beauty, paradise, Armenian identity", info: "Red rose = passion. White = purity. Karabakh famous for roses. 'Gul' carpets. Persian garden tradition.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Persian" },
                { icon: "üå∫", name: "Lotus", meaning: "Purity, enlightenment, rebirth, rising from mud", info: "Buddhist/Hindu symbol via Silk Road. Sacred flower. Rises pure from muddy water = spiritual transcendence.", value: "high", valueLabel: "HIGH VALUE", regions: "Persian, Silk Road" },
                { icon: "üå∑", name: "Tulip (‘º’°’¨’•/Lale)", meaning: "Perfect love, Ottoman luxury, spring, paradise", info: "Ottoman signature flower. 'Tulip Era' Turkey. Simple 3-petal form. Persian origin. Paradise garden.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Turkish, Persian" },
                { icon: "üåª", name: "Sunflower", meaning: "Sun worship, turning to divine, loyalty, summer", info: "Follows sun = devotion to God. Large medallion-like form. Later introduction (New World origin).", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Later carpets" },
                { icon: "üåº", name: "Carnation (’Ñ’•’≠’°’Ø/Mekhak)", meaning: "Divine love, pure affection, mother's love", info: "Christian passion flower. Ruffled petals distinctive. Pink/red common. Ottoman favorite.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Turkish, Armenian" },
                { icon: "üèµÔ∏è", name: "Rosette (General)", meaning: "Divine perfection, sun, radial harmony, center", info: "Geometric flower form. 6, 8, 12 petals common. Central medallion or scattered. Universal symbol.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "All regions" },
                { icon: "üçá", name: "Grape Vine (‘Ω’°’≤’∏’≤/Khaghagh)", meaning: "Wine, sacred blood, Georgian identity, abundance", info: "Georgian signature (ancient wine culture). Christian eucharist. Leaves and clusters. Harvest bounty.", value: "high", valueLabel: "HIGH VALUE (Georgian)", regions: "Georgian, Armenian" },
                { icon: "üçé", name: "Pomegranate (’Ü’∏÷Ç’º/Nur)", meaning: "Fertility, abundance, unity, Armenia symbol", info: "Many seeds = fertility. Unity in diversity. Armenian national symbol. Paradise fruit. Opened showing seeds.", value: "high", valueLabel: "HIGH VALUE", regions: "Armenian, Persian" },
                { icon: "üåæ", name: "Wheat Ear (’ë’∏÷Ä’•’∂/Ts'oren)", meaning: "Harvest, bread of life, prosperity, agricultural", info: "Staff of life. Harvest abundance. Rural wealth. Christian bread symbolism.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Agricultural regions" },
                { icon: "üåø", name: "Cypress Tree (’ç’°÷Ä’æ/Sarv)", meaning: "Eternity, mourning, graveyard, Zoroastrian sacred", info: "Evergreen = eternal life. Cemetery tree = death. Flame-like shape. Persian gardens. Zoroastrian holy tree.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian, Azerbaijani" },
                { icon: "üçÉ", name: "Leaf Scroll (Islimi)", meaning: "Growth, life force, Islamic art, continuous", info: "Flowing vine arabesque. Continuous growth. Islamic prohibition on figures = floral art excellence.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Islamic regions" },
                { icon: "üå∏", name: "Cherry Blossom", meaning: "Spring, renewal, ephemeral beauty, rebirth", info: "Brief bloom = life's transience. Spring renewal. Japanese/Persian garden influence.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian" },
                { icon: "ü™∑", name: "Water Lily", meaning: "Purity, floating grace, pond life, peace", info: "Floats on water = spiritual rising. Pond gardens. Related to lotus symbolism.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian gardens" },
                
                // GEOMETRIC & ABSTRACT SYMBOLS
                { icon: "üíé", name: "Diamond (Almast)", meaning: "Protection, evil eye, vaginal, feminine power", info: "Female symbol (womb). Elibelinde base form. Protective geometry. Stacked diamonds common.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Tribal carpets" },
                { icon: "üî∫", name: "Triangle (Muska)", meaning: "Amulet, protection, trinity, mountain", info: "Point up = masculine/fire. Point down = feminine/water. Trinity symbol. Caucasus mountains. Protective talisman.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "All regions" },
                { icon: "‚¨õ", name: "Square/Rectangle", meaning: "Earth, stability, four directions, order", info: "Four cardinal directions. Earthly realm. Stable foundation. Enclosed space = protection.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Geometric carpets" },
                { icon: "‚≠ï", name: "Circle", meaning: "Eternity, sun, wholeness, divine perfection", info: "No beginning/end = eternal. Sun disc. Mandala. Perfect divine form.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Medallion carpets" },
                { icon: "üí†", name: "Octagon", meaning: "Islamic architecture, transition square-circle, cosmic", info: "Eight directions. Dome transition geometry. Islamic tile work. Heaven/earth connection.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Islamic" },
                { icon: "üîÑ", name: "Swastika (Ha√ß)", meaning: "Ancient sun, good fortune, Aryan origin, pre-Nazi", info: "Right-facing = good fortune (pre-Nazi meaning only). Sun wheel. Indo-European. Caucasian pre-Christian.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Pre-1930 Caucasian" },
                { icon: "üëÅÔ∏è", name: "Evil Eye (Nazar)", meaning: "Protection from envy, ward off malice, blue eye", info: "Blue eye motif. Protective talisman. Deflects jealousy. Very common in Turkish/Caucasian.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Turkish, Caucasian" },
                { icon: "‚ö°", name: "Lightning (Yƒ±ldƒ±rƒ±m)", meaning: "Divine power, heaven's wrath, sudden illumination", info: "Zigzag diagonal patterns. God's power. Sudden truth. Sky fire. Kazak carpets.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian" },
                { icon: "‚òÄÔ∏è", name: "Sun (‘±÷Ä÷á/Arev)", meaning: "Life giver, divine light, Mithra worship, heat", info: "Solar worship (pre-Christian). Life source. Armenian Arev. Radial patterns. Central medallion often sun.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Pre-Christian Caucasian" },
                { icon: "üåô", name: "Moon/Crescent", meaning: "Islamic symbol, night, feminine, cycle, change", info: "Crescent with star = Islam. Lunar cycle = time/change. Feminine counterpart to sun.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Islamic" },
                { icon: "üí´", name: "Star Patterns (General)", meaning: "Heaven, divine guidance, night sky, fate", info: "Night sky representation. Divine order. Astrology. Multiple stars = cosmic arrangement.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "All regions" },
                { icon: "ü™¨", name: "Hamsa (Hand of Fatima)", meaning: "Protection, blessing, five fingers, warding", info: "Open palm. Five fingers. Islamic/Jewish protection. Ward off evil eye. Middle Eastern.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Islamic, Jewish" },
                { icon: "üî±", name: "Trident", meaning: "Triple power, Shiva, three realms, strength", info: "Rare in carpets. Hindu/Buddhist via trade. Three points = trinity/realms. Power symbol.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Trade route carpets" },
                { icon: "‚ôæÔ∏è", name: "Infinity/Endless Knot", meaning: "Eternal cycle, Buddhist wisdom, interconnection", info: "Buddhist endless knot. No beginning/end. Interconnected existence. Wisdom-compassion union.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Buddhist-influenced" },
                
                // SPECIAL PATTERNS & MOTIFS  
                { icon: "üèõÔ∏è", name: "Architectural (Buildings)", meaning: "Mosque, church, sacred space, prayer direction", info: "Mosque with minaret. Church with dome. Sacred architecture. Prayer rug specific.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Prayer rugs" },
                { icon: "‚õ≤", name: "Fountain/Water", meaning: "Paradise, life source, garden, purity", info: "Paradise garden water source. Persian chahar bagh. Life-giving water. Ritual purity.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Persian garden carpets" },
                { icon: "üïØÔ∏è", name: "Lamp/Kandil", meaning: "Divine light, mosque lamp, prayer, illumination", info: "Mosque lamp in prayer niche. Divine guidance light. Knowledge illumination. Hanging from mihrab.", value: "high", valueLabel: "HIGH VALUE", regions: "Prayer rugs" },
                { icon: "üìø", name: "Prayer Beads", meaning: "Devotion, counting prayers, meditation, Islam", info: "Islamic tasbih. 33 or 99 beads. Prayer counting. Devotional life.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Islamic" },
                { icon: "üó°Ô∏è", name: "Sword (’ç’∏÷Ç÷Ä/Sur)", meaning: "Warrior status, justice, Ali's Zulfiqar, power", info: "Double-edged = justice both ways. Zulfiqar (forked tip) = Shia Islam. Warrior class. Noble weapon.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Warrior cultures" },
                { icon: "üèπ", name: "Bow & Arrow", meaning: "Hunter, warrior, distance power, precision", info: "Hunting nobility. Military prowess. Striking from distance. Precision/skill.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Nomadic cultures" },
                { icon: "üõ°Ô∏è", name: "Shield", meaning: "Protection, defense, warrior, clan emblem", info: "Military protection. Clan identity. Defensive power. Coat of arms equivalent.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Warrior carpets" },
                { icon: "üëë", name: "Crown", meaning: "Royalty, divine authority, sovereignty, heaven", info: "Royal power. Divine right. Stepped crown = castle battlements. Heavenly crown.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Royal workshop carpets" },
                { icon: "üî•", name: "Fire/Flame", meaning: "Zoroastrian sacred, purification, divine, passion", info: "Zoroastrian sacred fire. Purification. Divine presence. Passion/love. Boteh flame.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Zoroastrian, Persian" },
                { icon: "üåä", name: "Water Waves", meaning: "Life source, flow, purification, change", info: "Flowing water = life. River of life. Purification ritual. Constant change/flow.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Border patterns" },
                { icon: "‚õ∞Ô∏è", name: "Mountain (‘º’•’º/Ler)", meaning: "Caucasus, sacred peak, Ararat, divine dwelling", info: "Mt. Ararat = Armenian sacred. Caucasus peaks. Gods' dwelling. Spiritual ascent. Stepped forms.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Caucasian" },
                { icon: "üåà", name: "Rainbow", meaning: "Divine covenant, bridge, hope, Noah's promise", info: "Biblical covenant. Heaven-earth bridge. After storm hope. Seven colors. Rare but meaningful.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Christian Armenian" },
                { icon: "‚òÅÔ∏è", name: "Clouds", meaning: "Heaven, divine realm, transformation, rain blessing", info: "Cloudbands (chi). Divine realm. Rain bringer = blessing. Sky symbols. Chinese influence.", value: "medium", valueLabel: "MEDIUM VALUE", regions: "Silk Road carpets" }
            ];
        }

        function getRegionData(region) {
            const data = {
                armenia: {
                    name: "üá¶üá≤ Armenian Carpets",
                    period: "1700-1920 (Golden Age)",
                    types: "Karabakh, Kazak, Erivan",
                    value: "$300-$5,000+ per fragment",
                    lookFor: [
                        "Dragon (vishap) motifs - S-curved forms",
                        "Armenian cross (khachkar) patterns",
                        "Cloudband designs (pre-1850 Karabakh)",
                        "Woven Armenian inscriptions or dates",
                        "Deep indigo + rich madder red colors",
                        "Thick pile with wool warps"
                    ],
                    weaveTypes: {
                        title: "Armenian Weave Recognition",
                        types: [
                            {
                                name: "Knotted Pile (Most Common)",
                                howToRecognize: "Turn carpet over - you'll see individual knot 'bumps' on the back. Run your hand against the pile direction - it should feel thick and woolly. Armenian pile is typically THICKER and COARSER than Persian.",
                                visual: "Back side shows grid of knots. Pile height usually 5-8mm. Wool feels 'grabby' not silky.",
                                knotType: "Symmetrical (Turkish/Ghiordes) knot - if you pull pile apart and look at base, each tuft wraps around TWO warp threads equally"
                            },
                            {
                                name: "Soumak (Weft-Wrapping)",
                                howToRecognize: "Back side looks like braided herringbone pattern. NO pile - totally flat. Front has slight diagonal ribbing texture. Feels like heavy fabric, not fuzzy.",
                                visual: "Diagonal weave visible on back. Looks woven, not knotted. Flat like a kilim but thicker and with diagonal texture.",
                                common: "Less common than pile. Often used for bags (mafrash) more than floor carpets."
                            }
                        ]
                    },
                    tip: "Armenian wool feels COARSER than Persian - not soft/silky. If it feels like cashmere, probably not Armenian. Wool should feel substantial, almost rough. Armenian letters woven anywhere = photograph immediately!"
                },
                azerbaijan: {
                    name: "üá¶üáø Azerbaijani Carpets",
                    period: "1800-1930 (Peak Quality)",
                    types: "Shirvan, Kuba, Baku, Ganja",
                    value: "$400-$4,000+ per fragment",
                    lookFor: [
                        "Prayer rugs with mihrab arch - PRIORITY",
                        "Very fine weaving (150-250 KPSI) = Kuba",
                        "Boteh (paisley) patterns in rows",
                        "Running dog borders",
                        "Dark blue/black grounds with ivory",
                        "Chi-Chi diagonal lattice (premium)"
                    ],
                    weaveTypes: {
                        title: "Azerbaijani Weave Recognition",
                        types: [
                            {
                                name: "Fine Knotted Pile (Kuba/Shirvan)",
                                howToRecognize: "VERY TIGHT weaving - count knots in 1 inch square. If 150-250+ knots = premium Kuba. Back side shows tiny, precise knot grid. Pile very SHORT (3-5mm). Feels dense and crisp, not fluffy.",
                                visual: "Hold up to light - very little light passes through = tight weave. Pattern on back is CLEAR and detailed, almost as clear as front.",
                                knotType: "Mostly symmetrical (Turkish) knot. Kuba uses finest knots in all Caucasus."
                            },
                            {
                                name: "Medium Pile (Shirvan Prayer Rugs)",
                                howToRecognize: "Tighter than Armenian but not as fine as Kuba. 100-150 KPSI typical. Pile height 4-6mm. Back shows clear pattern. Prayer rugs often have cotton WEFT (crosswise threads) with wool warp.",
                                visual: "Mihrab (prayer niche) visible clearly on both sides. Look for 'lamp' hanging from arch point on front.",
                                testTip: "Bend carpet - if it's very stiff and doesn't fold easily = tight quality Shirvan weave"
                            }
                        ]
                    },
                    tip: "Shirvan prayer rugs under $300 in good condition = buy immediately. Turn over - pattern should be CLEARLY visible on reverse like a mirror image. If fuzzy/unclear on back = likely reproduction."
                },
                georgia: {
                    name: "üá¨üá™ Georgian Carpets",
                    period: "1850-1920",
                    types: "Karachov, Tbilisi, Kilims",
                    value: "$100-$2,000 per fragment",
                    lookFor: [
                        "Christian cross motifs + Caucasian geometric",
                        "Grape vine borders (winemaking tradition)",
                        "Georgian script inscriptions",
                        "Bold stripes in kilims",
                        "Cruciform medallions"
                    ],
                    weaveTypes: {
                        title: "Georgian Weave Recognition",
                        types: [
                            {
                                name: "Kilim (Flat-Weave) - Most Common",
                                howToRecognize: "NO pile at all - completely flat both sides. Identical pattern front and back. Feels like heavy woven fabric. Look for SLIT-WEAVE technique: small vertical slits where colors meet (run finger along - you'll feel tiny gaps).",
                                visual: "Turn sideways and look at edge - should be THIN (2-4mm). No fuzz. Geometric patterns with bold color blocks.",
                                testTip: "Hold up to window - light comes through at color boundaries (the slits). This is NORMAL and correct for slit-weave kilim."
                            },
                            {
                                name: "Low Pile (Karachov)",
                                howToRecognize: "Thin pile (3-4mm). Coarser weave than Azerbaijani, similar to Armenian but lighter weight. Back shows knot pattern. Wool feels softer than Armenian, less dense than Azerbaijani.",
                                visual: "Often has long horizontal stripes or bands. Crosses integrated into geometric patterns.",
                                common: "Less common than kilims. Karachov district specialty."
                            }
                        ]
                    },
                    tip: "Georgian carpets SIGNIFICANTLY UNDERVALUED vs Armenian/Azerbaijani. Christian cross symbols = authenticates Georgian origin. Focus on pieces locals don't recognize value of. Kilims easiest to authenticate."
                },
                albania: {
                    name: "üá¶üá± Albanian Textiles",
                    period: "1850-1970",
                    types: "Kilims (Qilim), √áerga, rare Gjilim pile",
                    value: "$30-$400 per fragment (kilim), $300-$2,000 (pile)",
                    lookFor: [
                        "Large diamond medallions",
                        "Zigzag patterns",
                        "Slit-weave technique",
                        "Dark wool warps (brown/grey)",
                        "Albanian pile rugs = RARE, high value",
                        "Distinctive thick cord selvedge"
                    ],
                    weaveTypes: {
                        title: "Albanian Weave Recognition",
                        types: [
                            {
                                name: "Kilim (Qilim) - 90% of Albanian Textiles",
                                howToRecognize: "SLIT-WEAVE with LARGE SLITS - much bigger gaps than Georgian (sometimes 1-2 inches long). Very bold, simple geometric designs. Feels LOOSE and flexible compared to tight Persian kilims. Dark WARP threads often visible (brown/grey wool, not white cotton).",
                                visual: "Look at edges (selvedge) - often wrapped with THICK cord/yarn creating a distinctive 'rope' edge. Large diamond shapes common. Primary colors often red, black, white, orange.",
                                testTip: "Slits are NOT damage - they're intentional! Larger slits = older/more traditional. Some slits sewn closed = normal preservation."
                            },
                            {
                                name: "Pile Rugs (Gjilim) - VERY RARE",
                                howToRecognize: "If you find Albanian PILE = photograph everything! Very uncommon. Similar construction to Turkish but coarser. Symmetrical knots. Pile medium height (5-7mm). Designs similar to kilim patterns but in pile.",
                                visual: "Often has MIXED technique - pile field with kilim borders. Village work, not workshop quality.",
                                rarity: "Albanian pile fragments worth 5-10x more than kilim fragments due to rarity!"
                            }
                        ]
                    },
                    tip: "EMERGING MARKET - prices rising 20-30% annually. Pre-1950 kilim fragments $30-$150 in Albania sell for $200-$600 in Western markets. Focus on DOCUMENTED VILLAGE PROVENANCE - ask seller which village it's from!"
                },
                bulgaria: {
                    name: "üáßüá¨ Bulgarian Carpets",
                    period: "1850-1930 (Peak Quality)",
                    types: "Chiprovtsi UNESCO, Kotel, Rhodope",
                    value: "$200-$2,500 per fragment",
                    lookFor: [
                        "REVERSIBILITY - pattern identical both sides (Chiprovtsi)",
                        "Diagonal ribs on surface texture",
                        "Chiprovtsi rose motif",
                        "100% wool (no cotton in authentic old pieces)",
                        "Natural dyes with rich vibrant colors",
                        "Christian crosses + Ottoman patterns"
                    ],
                    weaveTypes: {
                        title: "Bulgarian Weave Recognition - CRITICAL FOR CHIPROVTSI",
                        types: [
                            {
                                name: "Chiprovtsi Double-Weave (THE PRIZE)",
                                howToRecognize: "THIS IS THE KEY TEST: Pattern must be PERFECTLY IDENTICAL on both sides - exact same colors, same design, no difference. Run finger across surface - you'll feel DIAGONAL RIBS (like corduroy at 45¬∞ angle). This is from oblique interlacing technique. Turn it over 20 times - sides should look identical every time.",
                                visual: "No 'right' or 'wrong' side - both sides are finished and identical. Slightly THICKER than regular kilim (4-6mm). Geometric rose patterns. Colors stay vibrant (natural dyes hold better in double-weave).",
                                testTip: "CRITICAL: If pattern is SIMILAR but not IDENTICAL on both sides = NOT true Chiprovtsi! Even small differences = fake. True Chiprovtsi is perfectly reversible.",
                                authentication: "Look for diagonal ribbing texture + perfect reversibility + rose motifs + all-wool (no cotton). All four must be present!"
                            },
                            {
                                name: "Regular Kilim (Kotel, Rhodope)",
                                howToRecognize: "Normal slit-weave kilim, not reversible. Pattern shows on both sides but BACK is slightly less clear. No diagonal ribbing. Good quality but not UNESCO-level.",
                                visual: "Bold geometric patterns. Christian crosses common. Red, black, white, yellow typical colors.",
                                value: "Still valuable but 1/3 price of true Chiprovtsi"
                            }
                        ]
                    },
                    tip: "Chiprovtsi carpets among most UNDERVALUED European textiles! UNESCO-recognized yet sell 50-70% less than Turkish equivalents. Pre-1920 Chiprovtsi fragment in excellent condition for $400-$800 would sell $2,000-$5,000 in London/NYC. REVERSIBILITY + DIAGONAL RIBS = authentication keys!"
                }
            };
            return data[region];
        }

        // Initialize
        window.onload = () => {
            renderSymbols();
        };
    </script>
</body>
</html>
